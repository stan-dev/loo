<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bayesian Stacking and Pseudo-BMA weights using the loo package • loo</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Bayesian Stacking and Pseudo-BMA weights using the loo package">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">loo</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.8.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Other Packages

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://mc-stan.org/rstan" class="external-link">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr" class="external-link">cmdstanr</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstanarm" class="external-link">rstanarm</a>
    </li>
    <li>
      <a href="https://mc-stan.org/bayesplot" class="external-link">bayesplot</a>
    </li>
    <li>
      <a href="https://mc-stan.org/shinystan" class="external-link">shinystan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/projpred" class="external-link">projpred</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstantools" class="external-link">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior" class="external-link">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://mc-stan.org" class="external-link">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan" class="external-link">
    <span class="fa fa-twitter"></span>

  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/loo" class="external-link">
    <span class="fa fa-github"></span>

  </a>
</li>
<li>
  <a href="https://discourse.mc-stan.org/" class="external-link">
    <span class="fa fa-users"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Bayesian Stacking and Pseudo-BMA weights using
the loo package</h1>
                        <h4 data-toc-skip class="author">Aki Vehtari and
Jonah Gabry</h4>
            
            <h4 data-toc-skip class="date">2025-06-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/loo/blob/HEAD/vignettes/loo2-weights.Rmd" class="external-link"><code>vignettes/loo2-weights.Rmd</code></a></small>
      <div class="hidden name"><code>loo2-weights.Rmd</code></div>

    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Bayesian Stacking and Pseudo-BMA weights}
-->
<p><strong>NOTE: We recommend viewing the fully rendered version of this
vignette online at <a href="https://mc-stan.org/loo/articles/" class="uri">https://mc-stan.org/loo/articles/</a></strong></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette demonstrates the new functionality in
<strong>loo</strong> v2.0.0 for Bayesian stacking and Pseudo-BMA
weighting. In this vignette we can’t provide all of the necessary
background on this topic, so we encourage readers to refer to the
paper</p>
<ul>
<li>Yao, Y., Vehtari, A., Simpson, D., and Gelman, A. (2018). Using
stacking to average Bayesian predictive distributions. In Bayesian
Analysis, :10.1214/17-BA1091. <a href="https://projecteuclid.org/euclid.ba/1516093227" class="external-link">Online</a>
</li>
</ul>
<p>which provides important details on the methods demonstrated in this
vignette. Here we just quote from the abstract of the paper:</p>
<blockquote>
<p><strong>Abstract</strong>: Bayesian model averaging is flawed in the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ℳ</mi><annotation encoding="application/x-tex">\mathcal{M}</annotation></semantics></math>-open
setting in which the true data-generating process is not one of the
candidate models being fit. We take the idea of stacking from the point
estimation literature and generalize to the combination of predictive
distributions. We extend the utility function to any proper scoring rule
and use Pareto smoothed importance sampling to efficiently compute the
required leave-one-out posterior distributions. We compare stacking of
predictive distributions to several alternatives: stacking of means,
Bayesian model averaging (BMA), Pseudo-BMA, and a variant of Pseudo-BMA
that is stabilized using the Bayesian bootstrap. Based on simulations
and real-data applications, we recommend stacking of predictive
distributions, with bootstrapped-Pseudo-BMA as an approximate
alternative when computation cost is an issue.</p>
</blockquote>
<p>Ideally, we would avoid the Bayesian model combination problem by
extending the model to include the separate models as special cases, and
preferably as a continuous expansion of the model space. For example,
instead of model averaging over different covariate combinations, all
potentially relevant covariates should be included in a predictive model
(for causal analysis more care is needed) and a prior assumption that
only some of the covariates are relevant can be presented with
regularized horseshoe prior (Piironen and Vehtari, 2017a). For variable
selection we recommend projective predictive variable selection
(Piironen and Vehtari, 2017a; <a href="https://cran.r-project.org/package=projpred" class="external-link"><strong>projpred</strong>
package</a>).</p>
<p>To demonstrate how to use <strong>loo</strong> package to compute
Bayesian stacking and Pseudo-BMA weights, we repeat two simple model
averaging examples from Chapters 6 and 10 of <em>Statistical
Rethinking</em> by Richard McElreath. In <em>Statistical Rethinking</em>
WAIC is used to form weights which are similar to classical “Akaike
weights”. Pseudo-BMA weighting using PSIS-LOO for computation is close
to these WAIC weights, but named after the Pseudo Bayes Factor by
Geisser and Eddy (1979). As discussed below, in general we prefer using
stacking rather than WAIC weights or the similar pseudo-BMA weights.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>In addition to the <strong>loo</strong> package we will also load the
<strong>rstanarm</strong> package for fitting the models.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstanarm/" class="external-link">rstanarm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/loo/">loo</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-primate-milk">Example: Primate milk<a class="anchor" aria-label="anchor" href="#example-primate-milk"></a>
</h2>
<p>In <em>Statistical Rethinking</em>, McElreath describes the data for
the primate milk example as follows:</p>
<blockquote>
<p>A popular hypothesis has it that primates with larger brains produce
more energetic milk, so that brains can grow quickly. … The question
here is to what extent energy content of milk, measured here by
kilocalories, is related to the percent of the brain mass that is
neocortex. … We’ll end up needing female body mass as well, to see the
masking that hides the relationships among the variables.</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">milk</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">milk</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">milk</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">neocortex</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">neocortex.perc</span> <span class="op">/</span><span class="fl">100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span></code></pre></div>
<p>We repeat the analysis in Chapter 6 of <em>Statistical
Rethinking</em> using the following four models (here we use the default
weakly informative priors in <strong>rstanarm</strong>, while flat
priors were used in <em>Statistical Rethinking</em>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/stan_glm.html" class="external-link">stan_glm</a></span><span class="op">(</span><span class="va">kcal.per.g</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">d</span>, seed <span class="op">=</span> <span class="fl">2030</span><span class="op">)</span></span>
<span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit1</span>, formula <span class="op">=</span> <span class="va">kcal.per.g</span> <span class="op">~</span> <span class="va">neocortex</span><span class="op">)</span></span>
<span><span class="va">fit3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit1</span>, formula <span class="op">=</span> <span class="va">kcal.per.g</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit1</span>, formula <span class="op">=</span> <span class="va">kcal.per.g</span> <span class="op">~</span> <span class="va">neocortex</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>McElreath uses WAIC for model comparison and averaging, so we’ll
start by also computing WAIC for these models so we can compare the
results to the other options presented later in the vignette. The
<strong>loo</strong> package provides <code>waic</code> methods for
log-likelihood arrays, matrices and functions. Since we fit our model
with rstanarm we can use the <code>waic</code> method provided by the
<strong>rstanarm</strong> package (a wrapper around <code>waic</code>
from the <strong>loo</strong> package), which allows us to just pass in
our fitted model objects instead of first extracting the log-likelihood
values.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">waic1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/waic.html">waic</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span></span>
<span><span class="va">waic2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/waic.html">waic</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span>
<span><span class="va">waic3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/waic.html">waic</a></span><span class="op">(</span><span class="va">fit3</span><span class="op">)</span></span>
<span><span class="va">waic4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/waic.html">waic</a></span><span class="op">(</span><span class="va">fit4</span><span class="op">)</span></span>
<span><span class="va">waics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="va">waic1</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"elpd_waic"</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>  <span class="va">waic2</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"elpd_waic"</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>  <span class="va">waic3</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"elpd_waic"</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>  <span class="va">waic4</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"elpd_waic"</span>, <span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We get some warnings when computing WAIC for models 3 and 4,
indicating that we shouldn’t trust the WAIC weights we will compute
later. Following the recommendation in the warning, we next use the
<code>loo</code> methods to compute PSIS-LOO instead. The
<strong>loo</strong> package provides <code>loo</code> methods for
log-likelihood arrays, matrices, and functions, but since we fit our
model with <strong>rstanarm</strong> we can just pass the fitted model
objects directly and <strong>rstanarm</strong> will extract the needed
values to pass to the <strong>loo</strong> package. (Like
<strong>rstanarm</strong>, some other R packages for fitting Stan
models, e.g. <strong>brms</strong>, also provide similar methods for
interfacing with the <strong>loo</strong> package.)</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># note: the loo function accepts a 'cores' argument that we recommend specifying</span></span>
<span><span class="co"># when working with bigger datasets</span></span>
<span></span>
<span><span class="va">loo1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span></span>
<span><span class="va">loo2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span>
<span><span class="va">loo3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit3</span><span class="op">)</span></span>
<span><span class="va">loo4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit4</span><span class="op">)</span></span>
<span><span class="va">lpd_point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  <span class="va">loo1</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>,<span class="st">"elpd_loo"</span><span class="op">]</span>, </span>
<span>  <span class="va">loo2</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>,<span class="st">"elpd_loo"</span><span class="op">]</span>,</span>
<span>  <span class="va">loo3</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>,<span class="st">"elpd_loo"</span><span class="op">]</span>, </span>
<span>  <span class="va">loo4</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>,<span class="st">"elpd_loo"</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>With <code>loo</code> we don’t get any warnings for models 3 and 4,
but for illustration of good results, we display the diagnostic details
for these models anyway.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo4</span><span class="op">)</span></span></code></pre></div>
<p>One benefit of PSIS-LOO over WAIC is better diagnostics. Here for
both models 3 and 4 all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>&lt;</mo><mn>0.7</mn></mrow><annotation encoding="application/x-tex">k&lt;0.7</annotation></semantics></math>
and the Monte Carlo SE of <code>elpd_loo</code> is 0.1 or less, and we
can expect the model comparison to be reliable.</p>
<p>Next we compute and compare 1) WAIC weights, 2) Pseudo-BMA weights
without Bayesian bootstrap, 3) Pseudo-BMA+ weights with Bayesian
bootstrap, and 4) Bayesian stacking weights.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">waic_wts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">waics</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">waics</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pbma_wts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo_model_weights.html">pseudobma_weights</a></span><span class="op">(</span><span class="va">lpd_point</span>, BB<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">pbma_BB_wts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo_model_weights.html">pseudobma_weights</a></span><span class="op">(</span><span class="va">lpd_point</span><span class="op">)</span> <span class="co"># default is BB=TRUE</span></span>
<span><span class="va">stacking_wts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo_model_weights.html">stacking_weights</a></span><span class="op">(</span><span class="va">lpd_point</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">waic_wts</span>, <span class="va">pbma_wts</span>, <span class="va">pbma_BB_wts</span>, <span class="va">stacking_wts</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>With all approaches Model 4 with <code>neocortex</code> and
<code>log(mass)</code> gets most of the weight. Based on theory,
Pseudo-BMA weights without Bayesian bootstrap should be close to WAIC
weights, and we can also see that here. Pseudo-BMA+ weights with
Bayesian bootstrap provide more cautious weights further away from 0 and
1 (see Yao et al. (2018) for a discussion of why this can be beneficial
and results from related experiments). In this particular example, the
Bayesian stacking weights are not much different from the other
weights.</p>
<p>One of the benefits of stacking is that it manages well if there are
many similar models. Consider for example that there could be many
irrelevant covariates that when included would produce a similar model
to one of the existing models. To emulate this situation here we simply
copy the first model a bunch of times, but you can imagine that instead
we would have ten alternative models with about the same predictive
performance. WAIC weights for such a scenario would be close to the
following:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">waic_wts_demo</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">waics</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">waics</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">waic_wts_demo</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>Notice how much the weight for model 4 is lowered now that more
models similar to model 1 (or in this case identical) have been added.
Both WAIC weights and Pseudo-BMA approaches first estimate the
predictive performance separately for each model and then compute
weights based on estimated relative predictive performances. Similar
models share similar weights so the weights of other models must be
reduced for the total sum of the weights to remain the same.</p>
<p>On the other hand, stacking optimizes the weights <em>jointly</em>,
allowing for the very similar models (in this toy example repeated
models) to share their weight while more unique models keep their
original weights. In our example we can see this difference clearly:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loo_model_weights.html">stacking_weights</a></span><span class="op">(</span><span class="va">lpd_point</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Using stacking, the weight for the best model stays essentially
unchanged.</p>
</div>
<div class="section level2">
<h2 id="example-oceanic-tool-complexity">Example: Oceanic tool complexity<a class="anchor" aria-label="anchor" href="#example-oceanic-tool-complexity"></a>
</h2>
<p>Another example we consider is the Kline oceanic tool complexity
data, which McElreath describes as follows:</p>
<blockquote>
<p>Different historical island populations possessed tool kits of
different size. These kits include fish hooks, axes, boats, hand plows,
and many other types of tools. A number of theories predict that larger
populations will both develop and sustain more complex tool kits. … It’s
also suggested that contact rates among populations effectively
increases population [sic, probably should be tool kit] size, as it’s
relevant to technological evolution.</p>
</blockquote>
<p>We build models predicting the total number of tools given the log
population size and the contact rate (high vs. low).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Kline</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">Kline</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">log_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">population</span><span class="op">)</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">contact_high</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">contact</span><span class="op">==</span><span class="st">"high"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span></code></pre></div>
<p>We start with a Poisson regression model with the log population
size, the contact rate, and an interaction term between them (priors are
informative priors as in <em>Statistical Rethinking</em>).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit10</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/stan_glm.html" class="external-link">stan_glm</a></span><span class="op">(</span></span>
<span>    <span class="va">total_tools</span> <span class="op">~</span> <span class="va">log_pop</span> <span class="op">+</span> <span class="va">contact_high</span> <span class="op">+</span> <span class="va">log_pop</span> <span class="op">*</span> <span class="va">contact_high</span>,</span>
<span>    family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">d</span>,</span>
<span>    prior <span class="op">=</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html" class="external-link">normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, autoscale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>    prior_intercept <span class="op">=</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html" class="external-link">normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, autoscale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">2030</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Before running other models, we check whether Poisson is good choice
as the conditional observation model.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo10</span><span class="op">)</span></span></code></pre></div>
<p>We get at least one observation with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>&gt;</mo><mn>0.7</mn></mrow><annotation encoding="application/x-tex">k&gt;0.7</annotation></semantics></math>
and the estimated effective number of parameters <code>p_loo</code> is
larger than the total number of parameters in the model. This indicates
that Poisson might be too narrow. A negative binomial model might be
better, but with so few observations it is not so clear.</p>
<p>We can compute LOO more accurately by running Stan again for the
leave-one-out folds with high
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
estimates. When using <strong>rstanarm</strong> this can be done by
specifying the <code>k_threshold</code> argument:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit10</span>, k_threshold<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo10</span><span class="op">)</span></span></code></pre></div>
<p>In this case we see that there is not much difference, and thus it is
relatively safe to continue.</p>
<p>As a comparison we also compute WAIC:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">waic10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/waic.html">waic</a></span><span class="op">(</span><span class="va">fit10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">waic10</span><span class="op">)</span></span></code></pre></div>
<p>The WAIC computation is giving warnings and the estimated ELPD is
slightly more optimistic. We recommend using the PSIS-LOO results
instead.</p>
<p>To assess whether the contact rate and interaction term are useful,
we can make a comparison to models without these terms.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit10</span>, formula <span class="op">=</span> <span class="va">total_tools</span> <span class="op">~</span> <span class="va">log_pop</span> <span class="op">+</span> <span class="va">contact_high</span><span class="op">)</span></span>
<span><span class="va">fit12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit10</span>, formula <span class="op">=</span> <span class="va">total_tools</span> <span class="op">~</span> <span class="va">log_pop</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">loo11</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">loo12</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit12</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo11</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit11</span>, k_threshold<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="va">loo12</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit12</span>, k_threshold<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="va">lpd_point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  <span class="va">loo10</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>, <span class="st">"elpd_loo"</span><span class="op">]</span>, </span>
<span>  <span class="va">loo11</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>, <span class="st">"elpd_loo"</span><span class="op">]</span>, </span>
<span>  <span class="va">loo12</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>, <span class="st">"elpd_loo"</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>For comparison we’ll also compute WAIC values for these additional
models:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">waic11</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/waic.html">waic</a></span><span class="op">(</span><span class="va">fit11</span><span class="op">)</span></span>
<span><span class="va">waic12</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/waic.html">waic</a></span><span class="op">(</span><span class="va">fit12</span><span class="op">)</span></span>
<span><span class="va">waics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="va">waic10</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"elpd_waic"</span>, <span class="fl">1</span><span class="op">]</span>, </span>
<span>  <span class="va">waic11</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"elpd_waic"</span>, <span class="fl">1</span><span class="op">]</span>, </span>
<span>  <span class="va">waic12</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"elpd_waic"</span>, <span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The WAIC computation again gives warnings, and we recommend using
PSIS-LOO instead.</p>
<p>Finally, we compute 1) WAIC weights, 2) Pseudo-BMA weights without
Bayesian bootstrap, 3) Pseudo-BMA+ weights with Bayesian bootstrap, and
4) Bayesian stacking weights.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">waic_wts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">waics</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">waics</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pbma_wts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo_model_weights.html">pseudobma_weights</a></span><span class="op">(</span><span class="va">lpd_point</span>, BB<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">pbma_BB_wts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo_model_weights.html">pseudobma_weights</a></span><span class="op">(</span><span class="va">lpd_point</span><span class="op">)</span> <span class="co"># default is BB=TRUE</span></span>
<span><span class="va">stacking_wts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo_model_weights.html">stacking_weights</a></span><span class="op">(</span><span class="va">lpd_point</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">waic_wts</span>, <span class="va">pbma_wts</span>, <span class="va">pbma_BB_wts</span>, <span class="va">stacking_wts</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>All weights favor the second model with the log population and the
contact rate. WAIC weights and Pseudo-BMA weights (without Bayesian
bootstrap) are similar, while Pseudo-BMA+ is more cautious and closer to
stacking weights.</p>
<p>It may seem surprising that Bayesian stacking is giving zero weight
to the first model, but this is likely due to the fact that the
estimated effect for the interaction term is close to zero and thus
models 1 and 2 give very similar predictions. In other words,
incorporating the model with the interaction (model 1) into the model
average doesn’t improve the predictions at all and so model 1 is given a
weight of 0. On the other hand, models 2 and 3 are giving slightly
different predictions and thus their combination may be slightly better
than either alone. This behavior is related to the repeated similar
model illustration in the milk example above.</p>
</div>
<div class="section level2">
<h2 id="simpler-coding-using-loo_model_weights-function">Simpler coding using <code>loo_model_weights</code> function<a class="anchor" aria-label="anchor" href="#simpler-coding-using-loo_model_weights-function"></a>
</h2>
<p>Although in the examples above we called the
<code>stacking_weights</code> and <code>pseudobma_weights</code>
functions directly, we can also use the <code>loo_model_weights</code>
wrapper, which takes as its input either a list of pointwise
log-likelihood matrices or a list of precomputed loo objects. There are
also <code>loo_model_weights</code> methods for stanreg objects (fitted
model objects from <strong>rstanarm</strong>) as well as fitted model
objects from other packages (e.g. <strong>brms</strong>) that do the
preparation work for the user (see, e.g., the examples at
<code><a href="https://mc-stan.org/loo/reference/loo_model_weights.html">help("loo_model_weights", package = "rstanarm")</a></code>).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># using list of loo objects</span></span>
<span><span class="va">loo_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">loo10</span>, <span class="va">loo11</span>, <span class="va">loo12</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/loo_model_weights.html">loo_model_weights</a></span><span class="op">(</span><span class="va">loo_list</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/loo_model_weights.html">loo_model_weights</a></span><span class="op">(</span><span class="va">loo_list</span>, method <span class="op">=</span> <span class="st">"pseudobma"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/loo_model_weights.html">loo_model_weights</a></span><span class="op">(</span><span class="va">loo_list</span>, method <span class="op">=</span> <span class="st">"pseudobma"</span>, BB <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>McElreath, R. (2016). <em>Statistical rethinking: A Bayesian course
with examples in R and Stan</em>. Chapman &amp; Hall/CRC. <a href="http://xcelab.net/rm/statistical-rethinking/" class="external-link uri">http://xcelab.net/rm/statistical-rethinking/</a></p>
<p>Piironen, J. and Vehtari, A. (2017a). Sparsity information and
regularization in the horseshoe and other shrinkage priors. In
Electronic Journal of Statistics, 11(2):5018-5051. <a href="https://projecteuclid.org/euclid.ejs/1513306866" class="external-link">Online</a>.</p>
<p>Piironen, J. and Vehtari, A. (2017b). Comparison of Bayesian
predictive methods for model selection. Statistics and Computing,
27(3):711-735. :10.1007/s11222-016-9649-y. <a href="https://link.springer.com/article/10.1007/s11222-016-9649-y" class="external-link">Online</a>.</p>
<p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical Bayesian
model evaluation using leave-one-out cross-validation and WAIC.
<em>Statistics and Computing</em>. 27(5), 1413–1432.
:10.1007/s11222-016-9696-4. <a href="https://link.springer.com/article/10.1007/s11222-016-9696-4" class="external-link">online</a>,
<a href="https://arxiv.org/abs/1507.04544" class="external-link">arXiv preprint
arXiv:1507.04544</a>.</p>
<p>Vehtari, A., Simpson, D., Gelman, A., Yao, Y., and Gabry, J. (2024).
Pareto smoothed importance sampling. <em>Journal of Machine Learning
Research</em>, 25(72):1-58. <a href="https://jmlr.org/papers/v25/19-556.html" class="external-link">PDF</a></p>
<p>Yao, Y., Vehtari, A., Simpson, D., and Gelman, A. (2018). Using
stacking to average Bayesian predictive distributions. In Bayesian
Analysis, :10.1214/17-BA1091. <a href="https://projecteuclid.org/euclid.ba/1516093227" class="external-link">Online</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Aki Vehtari, Jonah Gabry, Måns Magnusson, Yuling Yao, Paul-Christian Bürkner, Topi Paananen, Andrew Gelman.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
