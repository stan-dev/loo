<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- upstream: inst/BS5/templates/head.html; pkgdown-version: 2.1.3, fe04924 --><!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 --><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Holdout validation and K-fold cross-validation of Stan programs with the loo package • loo</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_3-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- Font Awesome 7.0.1 for Bluesky icon --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" referrerpolicy="no-referrer">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Holdout validation and K-fold cross-validation of Stan programs with the loo package">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <!-- upstream: inst/BS5/templates/navbar.html; pkgdown-version: 2.1.3, fe04924 -->
<!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 -->
<nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">


    <a class="navbar-brand me-2" href="../index.html">
      <!-- Add Stan logo -->
      <picture><source type="image/svg+xml" srcset="../logo.svg"><img src="../logo.png" class="stan-logo" alt="Stan blue hex logo"></source></picture>
      loo
    </a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.8.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-other-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Other Packages</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-other-packages">
<li><a class="external-link dropdown-item" href="https://mc-stan.org/bayesplot">bayesplot</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/cmdstanr">cmdstanr</a></li>
    <li><a class="dropdown-item" href="https://mc-stan.org/loo">loo</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/posterior">posterior</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/projpred">projpred</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstan">rstan</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstanarm">rstanarm</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstantools">rstantools</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/shinystan">shinystan</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mc-stan.org/about/">About Stan</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/did:plc:qznndgdnkem2yryu7ipqbpv7" aria-label="Visit our Bluesky profile"><span class="fa fa-brands fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/mcmc_stan" aria-label="Visit our Twitter profile"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://discourse.mc-stan.org/" aria-label="Visit our forums"><span class="fa fa-users"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stan-dev/loo/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Holdout validation and K-fold cross-validation of Stan programs with the loo package</h1>
                        <h4 data-toc-skip class="author">Bruno
Nicenboim</h4>
            
            <h4 data-toc-skip class="date">2025-09-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/loo/blob/HEAD/vignettes/loo2-elpd.Rmd" class="external-link"><code>vignettes/loo2-elpd.Rmd</code></a></small>
      <div class="d-none name"><code>loo2-elpd.Rmd</code></div>
    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Holdout validation and K-fold cross-validation of Stan programs with the loo package}
-->
<p><strong>NOTE: We recommend viewing the fully rendered version of this
vignette online at <a href="https://mc-stan.org/loo/articles/" class="uri">https://mc-stan.org/loo/articles/</a></strong></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette demonstrates how to do holdout validation and K-fold
cross-validation with <strong>loo</strong> for a Stan program.</p>
</div>
<div class="section level2">
<h2 id="example-eradication-of-roaches-using-holdout-validation-approach">Example: Eradication of Roaches using holdout validation
approach<a class="anchor" aria-label="anchor" href="#example-eradication-of-roaches-using-holdout-validation-approach"></a>
</h2>
<p>This vignette uses the same example as in the vignettes <a href="http://mc-stan.org/loo/articles/loo2-example.html" class="external-link"><em>Using the
loo package (version &gt;= 2.0.0)</em></a> and <a href="https://mc-stan.org/loo/articles/loo2-moment-matching.html"><em>Avoiding
model refits in leave-one-out cross-validation with moment
matching</em></a>.</p>
<div class="section level3">
<h3 id="coding-the-stan-model">Coding the Stan model<a class="anchor" aria-label="anchor" href="#coding-the-stan-model"></a>
</h3>
<p>Here is the Stan code for fitting a Poisson regression model:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note: some syntax used in this Stan program requires RStan &gt;= 2.26 (or CmdStanR)</span></span>
<span><span class="co"># To use an older version of RStan change the line declaring `y` to: int y[N];</span></span>
<span><span class="va">stancode</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">data {</span></span>
<span><span class="st">  int&lt;lower=1&gt; K;</span></span>
<span><span class="st">  int&lt;lower=1&gt; N;</span></span>
<span><span class="st">  matrix[N,K] x;</span></span>
<span><span class="st">  array[N] int y;</span></span>
<span><span class="st">  vector[N] offset;</span></span>
<span><span class="st"></span></span>
<span><span class="st">  real beta_prior_scale;</span></span>
<span><span class="st">  real alpha_prior_scale;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">parameters {</span></span>
<span><span class="st">  vector[K] beta;</span></span>
<span><span class="st">  real intercept;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">model {</span></span>
<span><span class="st">  y ~ poisson(exp(x * beta + intercept + offset));</span></span>
<span><span class="st">  beta ~ normal(0,beta_prior_scale);</span></span>
<span><span class="st">  intercept ~ normal(0,alpha_prior_scale);</span></span>
<span><span class="st">}</span></span>
<span><span class="st">generated quantities {</span></span>
<span><span class="st">  vector[N] log_lik;</span></span>
<span><span class="st">  for (n in 1:N)</span></span>
<span><span class="st">    log_lik[n] = poisson_lpmf(y[n] | exp(x[n] * beta + intercept + offset[n]));</span></span>
<span><span class="st">}</span></span>
<span><span class="st">"</span></span></code></pre></div>
<p>Following the usual approach recommended in <a href="http://mc-stan.org/loo/articles/loo2-with-rstan.html" class="external-link"><em>Writing
Stan programs for use with the loo package</em></a>, we compute the
log-likelihood for each observation in the
<code>generated quantities</code> block of the Stan program.</p>
</div>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<p>In addition to <strong>loo</strong>, we load the
<strong>rstan</strong> package for fitting the model. We will also need
the <strong>rstanarm</strong> package for the data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mc-stan.org/rstan/" class="external-link">"rstan"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mc-stan.org/loo/">"loo"</a></span><span class="op">)</span></span>
<span><span class="va">seed</span> <span class="op">&lt;-</span> <span class="fl">9547</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="holdout-validation">Holdout validation<a class="anchor" aria-label="anchor" href="#holdout-validation"></a>
</h2>
<p>For this approach, the model is first fit to the “train” data and
then is evaluated on the held-out “test” data.</p>
<div class="section level3">
<h3 id="splitting-the-data-between-train-and-test">Splitting the data between train and test<a class="anchor" aria-label="anchor" href="#splitting-the-data-between-train-and-test"></a>
</h3>
<p>The data is divided between train (80% of the data) and test
(20%):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">roaches</span>, package <span class="op">=</span> <span class="st">"rstanarm"</span><span class="op">)</span></span>
<span><span class="va">roaches</span><span class="op">$</span><span class="va">roach1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">$</span><span class="va">roach1</span><span class="op">)</span></span>
<span><span class="va">roaches</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span>,<span class="st">"exposure2"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># 20% of the data goes to the test set:</span></span>
<span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">.2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># data to "train" the model</span></span>
<span><span class="va">data_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>,</span>
<span>                   x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>                                         <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"roach1"</span>, <span class="st">"treatment"</span>, <span class="st">"senior"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                   N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">0</span>,<span class="op">]</span><span class="op">)</span>,</span>
<span>                   K <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                   offset <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">offset</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>,</span>
<span>                   beta_prior_scale <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>                   alpha_prior_scale <span class="op">=</span> <span class="fl">5.0</span></span>
<span>                   <span class="op">)</span></span>
<span><span class="co"># data to "test" the model</span></span>
<span><span class="va">data_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>,</span>
<span>                   x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>                                         <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"roach1"</span>, <span class="st">"treatment"</span>, <span class="st">"senior"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                   N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">1</span>,<span class="op">]</span><span class="op">)</span>,</span>
<span>                   K <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                   offset <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">offset</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>,</span>
<span>                   beta_prior_scale <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>                   alpha_prior_scale <span class="op">=</span> <span class="fl">5.0</span></span>
<span>                   <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fitting-the-model-with-rstan">Fitting the model with RStan<a class="anchor" aria-label="anchor" href="#fitting-the-model-with-rstan"></a>
</h3>
<p>Next we fit the model to the “test” data in Stan using the
<strong>rstan</strong> package:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compile</span></span>
<span><span class="va">stanmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span>model_code <span class="op">=</span> <span class="va">stancode</span><span class="op">)</span></span>
<span><span class="co"># Fit model</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span><span class="va">stanmodel</span>, data <span class="op">=</span> <span class="va">data_train</span>, seed <span class="op">=</span> <span class="va">seed</span>, refresh <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>We recompute the generated quantities using the posterior draws
conditional on the training data, but we now pass in the held-out data
to get the log predictive densities for the test data. Because we are
using independent data, the log predictive density coincides with the
log likelihood of the test data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gen_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-gqs.html" class="external-link">gqs</a></span><span class="op">(</span><span class="va">stanmodel</span>, draws <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>, data<span class="op">=</span> <span class="va">data_test</span><span class="op">)</span></span>
<span><span class="va">log_pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_log_lik.html">extract_log_lik</a></span><span class="op">(</span><span class="va">gen_test</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="computing-holdout-elpd">Computing holdout elpd:<a class="anchor" aria-label="anchor" href="#computing-holdout-elpd"></a>
</h3>
<p>Now we evaluate the predictive performance of the model on the test
data using <code><a href="../reference/elpd.html">elpd()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">elpd_holdout</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/elpd.html">elpd</a></span><span class="op">(</span><span class="va">log_pd</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>When one wants to compare different models, the function
<code><a href="../reference/loo_compare.html">loo_compare()</a></code> can be used to assess the difference in
performance.</p>
</div>
</div>
<div class="section level2">
<h2 id="k-fold-cross-validation">K-fold cross validation<a class="anchor" aria-label="anchor" href="#k-fold-cross-validation"></a>
</h2>
<p>For this approach the data is divided into folds, and each time one
fold is tested while the rest of the data is used to fit the model (see
Vehtari et al., 2017).</p>
<div class="section level3">
<h3 id="splitting-the-data-in-folds">Splitting the data in folds<a class="anchor" aria-label="anchor" href="#splitting-the-data-in-folds"></a>
</h3>
<p>We use the data that is already pre-processed and we divide it in 10
random folds using <code>kfold_split_random</code></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data</span></span>
<span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfold-helpers.html">kfold_split_random</a></span><span class="op">(</span>K <span class="op">=</span> <span class="fl">10</span>, N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fitting-and-extracting-the-log-pointwise-predictive-densities-for-each-fold">Fitting and extracting the log pointwise predictive densities for
each fold<a class="anchor" aria-label="anchor" href="#fitting-and-extracting-the-log-pointwise-predictive-densities-for-each-fold"></a>
</h3>
<p>We now loop over the 10 folds. In each fold we do the following.
First, we fit the model to all the observations except the ones
belonging to the left-out fold. Second, we compute the log pointwise
predictive densities for the left-out fold. Last, we store the
predictive density for the observations of the left-out fold in a
matrix. The output of this loop is a matrix of the log pointwise
predictive densities of all the observations.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare a matrix with the number of post-warmup iterations by number of observations:</span></span>
<span><span class="va">log_pd_kfold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">4000</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Loop over the folds</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">data_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">!=</span> <span class="va">k</span><span class="op">]</span>,</span>
<span>                   x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">!=</span> <span class="va">k</span>,</span>
<span>                                         <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"roach1"</span>, <span class="st">"treatment"</span>, <span class="st">"senior"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                   N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">!=</span> <span class="va">k</span>,<span class="op">]</span><span class="op">)</span>,</span>
<span>                   K <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                   offset <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">offset</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">!=</span> <span class="va">k</span><span class="op">]</span>,</span>
<span>                   beta_prior_scale <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>                   alpha_prior_scale <span class="op">=</span> <span class="fl">5.0</span></span>
<span>                   <span class="op">)</span></span>
<span>  <span class="va">data_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="va">k</span><span class="op">]</span>,</span>
<span>                   x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="va">k</span>,</span>
<span>                                         <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"roach1"</span>, <span class="st">"treatment"</span>, <span class="st">"senior"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                   N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="va">k</span>,<span class="op">]</span><span class="op">)</span>,</span>
<span>                   K <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                   offset <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">offset</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="va">k</span><span class="op">]</span>,</span>
<span>                   beta_prior_scale <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>                   alpha_prior_scale <span class="op">=</span> <span class="fl">5.0</span></span>
<span>                   <span class="op">)</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span><span class="va">stanmodel</span>, data <span class="op">=</span> <span class="va">data_train</span>, seed <span class="op">=</span> <span class="va">seed</span>, refresh <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">gen_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-gqs.html" class="external-link">gqs</a></span><span class="op">(</span><span class="va">stanmodel</span>, draws <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>, data<span class="op">=</span> <span class="va">data_test</span><span class="op">)</span></span>
<span>  <span class="va">log_pd_kfold</span><span class="op">[</span>, <span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_log_lik.html">extract_log_lik</a></span><span class="op">(</span><span class="va">gen_test</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="computing-k-fold-elpd">Computing K-fold elpd:<a class="anchor" aria-label="anchor" href="#computing-k-fold-elpd"></a>
</h3>
<p>Now we evaluate the predictive performance of the model on the 10
folds using <code><a href="../reference/elpd.html">elpd()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">elpd_kfold</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/elpd.html">elpd</a></span><span class="op">(</span><span class="va">log_pd_kfold</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>If one wants to compare several models (with
<code>loo_compare</code>), one should use the same folds for all the
different models.</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Gelman, A., and Hill, J. (2007). <em>Data Analysis Using Regression
and Multilevel Hierarchical Models.</em> Cambridge University Press.</p>
<p>Stan Development Team (2020) <em>RStan: the R interface to Stan,
Version 2.21.1</em> <a href="https://mc-stan.org" class="external-link uri">https://mc-stan.org</a></p>
<p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical Bayesian
model evaluation using leave-one-out cross-validation and WAIC.
<em>Statistics and Computing</em>. 27(5), 1413–1432.
:10.1007/s11222-016-9696-4. Links: <a href="https://link.springer.com/article/10.1007/s11222-016-9696-4" class="external-link">published</a>
| <a href="https://arxiv.org/abs/1507.04544" class="external-link">arXiv preprint</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Aki Vehtari, Jonah Gabry, Måns Magnusson, Yuling Yao, Paul-Christian Bürkner, Topi Paananen, Andrew Gelman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
