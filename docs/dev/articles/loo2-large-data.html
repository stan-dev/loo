<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- upstream: inst/BS5/templates/head.html; pkgdown-version: 2.1.3, fe04924 --><!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 --><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using Leave-one-out cross-validation for large data • loo</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_3-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- Font Awesome 7.0.1 for Bluesky icon --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" referrerpolicy="no-referrer">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using Leave-one-out cross-validation for large data">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <!-- upstream: inst/BS5/templates/navbar.html; pkgdown-version: 2.1.3, fe04924 -->
<!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 -->
<nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">


    <a class="navbar-brand me-2" href="../index.html">
      <!-- Add Stan logo -->
      <picture><source type="image/svg+xml" srcset="../logo.svg"><img src="../logo.png" class="stan-logo" alt="Stan blue hex logo"></source></picture>
      loo
    </a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.8.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-other-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Other Packages</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-other-packages">
<li><a class="external-link dropdown-item" href="https://mc-stan.org/bayesplot">bayesplot</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/cmdstanr">cmdstanr</a></li>
    <li><a class="dropdown-item" href="https://mc-stan.org/loo">loo</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/posterior">posterior</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/projpred">projpred</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstan">rstan</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstanarm">rstanarm</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstantools">rstantools</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/shinystan">shinystan</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mc-stan.org/about/">About Stan</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/did:plc:qznndgdnkem2yryu7ipqbpv7" aria-label="Visit our Bluesky profile"><span class="fa fa-brands fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/mcmc_stan" aria-label="Visit our Twitter profile"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://discourse.mc-stan.org/" aria-label="Visit our forums"><span class="fa fa-users"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stan-dev/loo/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Using Leave-one-out cross-validation for large data</h1>
                        <h4 data-toc-skip class="author">Mans Magnusson,
Paul Bürkner, Aki Vehtari and Jonah Gabry</h4>
            
            <h4 data-toc-skip class="date">2025-09-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/loo/blob/HEAD/vignettes/loo2-large-data.Rmd" class="external-link"><code>vignettes/loo2-large-data.Rmd</code></a></small>
      <div class="d-none name"><code>loo2-large-data.Rmd</code></div>
    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Using Leave-one-out cross-validation for large data}
-->
<p><strong>NOTE: We recommend viewing the fully rendered version of this
vignette online at <a href="https://mc-stan.org/loo/articles/" class="uri">https://mc-stan.org/loo/articles/</a></strong></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette demonstrates how to do leave-one-out cross-validation
for large data using the <strong>loo</strong> package and Stan. There
are two approaches covered: LOO with subsampling and LOO using
approximations to posterior distributions. Some sections from this
vignette are excerpted from the papers</p>
<ul>
<li><p>Magnusson, M., Riis Andersen, M., Jonasson, J. and Vehtari, A.
(2020). Leave-One-Out Cross-Validation for Model Comparison in Large
Data. Proceedings of the 23rd International Conference on Artificial
Intelligence and Statistics (AISTATS), in PMLR 108. <a href="https://arxiv.org/abs/2001.00980" class="external-link">arXiv preprint
arXiv:2001.00980</a>.</p></li>
<li><p>Magnusson, M., Andersen, M., Jonasson, J. &amp; Vehtari, A.
(2019). Bayesian leave-one-out cross-validation for large data.
Proceedings of the 36th International Conference on Machine Learning, in
PMLR 97:4244-4253 <a href="http://proceedings.mlr.press/v97/magnusson19a.html" class="external-link">online</a>, <a href="https://arxiv.org/abs/1904.10679" class="external-link">arXiv preprint
arXiv:1904.10679</a>.</p></li>
<li><p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical Bayesian
model evaluation using leave-one-out cross-validation and WAIC.
<em>Statistics and Computing</em>. 27(5), 1413–1432.
:10.1007/s11222-016-9696-4. Links: <a href="https://link.springer.com/article/10.1007/s11222-016-9696-4" class="external-link">published</a>
| <a href="https://arxiv.org/abs/1507.04544" class="external-link">arXiv
preprint</a>.</p></li>
<li><p>Vehtari, A., Simpson, D., Gelman, A., Yao, Y., and Gabry, J.
(2024). Pareto smoothed importance sampling. <em>Journal of Machine
Learning Research</em>, 25(72):1-58. <a href="https://jmlr.org/papers/v25/19-556.html" class="external-link">PDF</a></p></li>
</ul>
<p>which provide important background for understanding the methods
implemented in the package.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>In addition to the <strong>loo</strong> package, we’ll also be using
<strong>rstan</strong>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mc-stan.org/rstan/" class="external-link">"rstan"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mc-stan.org/loo/">"loo"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">4711</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-well-water-in-bangladesh">Example: Well water in Bangladesh<a class="anchor" aria-label="anchor" href="#example-well-water-in-bangladesh"></a>
</h2>
<p>We will use the same example as in the vignette <a href="http://mc-stan.org/loo/articles/loo2-with-rstan.html" class="external-link"><em>Writing
Stan programs for use with the loo package</em></a>. See that vignette
for a description of the problem and data.</p>
<p>The sample size in this example is only
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>3020</mn></mrow><annotation encoding="application/x-tex">N=3020</annotation></semantics></math>,
which is not large enough to <em>require</em> the special methods for
large data described in this vignette, but is sufficient for
demonstration purposes in this tutorial.</p>
<div class="section level3">
<h3 id="coding-the-stan-model">Coding the Stan model<a class="anchor" aria-label="anchor" href="#coding-the-stan-model"></a>
</h3>
<p>Here is the Stan code for fitting the logistic regression model,
which we save in a file called <code>logistic.stan</code>:</p>
<pre><code>// Note: some syntax used in this program requires RStan &gt;= 2.26 (or CmdStanR)
// To use an older version of RStan change the line declaring `y` to:
//    int&lt;lower=0,upper=1&gt; y[N];
data {
  int&lt;lower=0&gt; N;             // number of data points
  int&lt;lower=0&gt; P;             // number of predictors (including intercept)
  matrix[N,P] X;              // predictors (including 1s for intercept)
  array[N] int&lt;lower=0,upper=1&gt; y;  // binary outcome
}
parameters {
  vector[P] beta;
}
model {
  beta ~ normal(0, 1);
  y ~ bernoulli_logit(X * beta);
}</code></pre>
<p>Importantly, unlike the general approach recommended in <a href="http://mc-stan.org/loo/articles/loo2-with-rstan.html" class="external-link"><em>Writing
Stan programs for use with the loo package</em></a>, we do <em>not</em>
compute the log-likelihood for each observation in the
<code>generated quantities</code> block of the Stan program. Here we are
assuming we have a large data set (larger than the one we’re actually
using in this demonstration) and so it is preferable to instead define a
function in R to compute the log-likelihood for each data point when
needed rather than storing all of the log-likelihood values in
memory.</p>
<p>The log-likelihood in R can be coded as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># we'll add an argument log to toggle whether this is a log-likelihood or </span></span>
<span><span class="co"># likelihood function. this will be useful later in the vignette.</span></span>
<span><span class="va">llfun_logistic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_i</span>, <span class="va">draws</span>, <span class="va">log</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">data_i</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data_i</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span><span class="op">)</span>, drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">logit_pred</span> <span class="op">&lt;-</span> <span class="va">draws</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x_i</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data_i</span><span class="op">$</span><span class="va">y</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">logit_pred</span><span class="op">)</span><span class="op">)</span>, log <span class="op">=</span> <span class="va">log</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The function <code>llfun_logistic()</code> needs to have arguments
<code>data_i</code> and <code>draws</code>. Below we will test that the
function is working by using the <code><a href="../reference/loo.html">loo_i()</a></code> function.</p>
</div>
<div class="section level3">
<h3 id="fitting-the-model-with-rstan">Fitting the model with RStan<a class="anchor" aria-label="anchor" href="#fitting-the-model-with-rstan"></a>
</h3>
<p>Next we fit the model in Stan using the <strong>rstan</strong>
package:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data</span></span>
<span><span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"http://stat.columbia.edu/~gelman/arm/examples/arsenic/wells.dat"</span></span>
<span><span class="va">wells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span><span class="va">wells</span><span class="op">$</span><span class="va">dist100</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">wells</span>, <span class="va">dist</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">dist100</span> <span class="op">+</span> <span class="va">arsenic</span>, <span class="va">wells</span><span class="op">)</span></span>
<span><span class="va">standata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">wells</span><span class="op">$</span><span class="va">switch</span>, X <span class="op">=</span> <span class="va">X</span>, N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, P <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compile</span></span>
<span><span class="va">stan_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span><span class="st">"logistic.stan"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit model</span></span>
<span><span class="va">fit_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span><span class="va">stan_mod</span>, data <span class="op">=</span> <span class="va">standata</span>, seed <span class="op">=</span> <span class="fl">4711</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit_1</span>, pars <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span></span></code></pre></div>
<pre><code>         mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
beta[1]  0.00       0 0.08 -0.15 -0.05  0.00  0.06  0.16  1933    1
beta[2] -0.89       0 0.10 -1.09 -0.96 -0.89 -0.82 -0.69  2332    1
beta[3]  0.46       0 0.04  0.38  0.43  0.46  0.49  0.54  2051    1</code></pre>
<p>Before we move on to computing LOO we can now test that the
log-likelihood function we wrote is working as it should. The
<code><a href="../reference/loo.html">loo_i()</a></code> function is a helper function that can be used to
test a log-likelihood function on a single observation.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># used for draws argument to loo_i</span></span>
<span><span class="va">parameter_draws_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit_1</span><span class="op">)</span><span class="op">$</span><span class="va">beta</span></span>
<span></span>
<span><span class="co"># used for data argument to loo_i</span></span>
<span><span class="va">stan_df_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">standata</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># compute relative efficiency (this is slow and optional but is recommended to allow </span></span>
<span><span class="co"># for adjusting PSIS effective sample size based on MCMC effective sample size)</span></span>
<span><span class="va">r_eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/relative_eff.html">relative_eff</a></span><span class="op">(</span><span class="va">llfun_logistic</span>, </span>
<span>                      log <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># relative_eff wants likelihood not log-likelihood values</span></span>
<span>                      chain_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, each <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>, </span>
<span>                      data <span class="op">=</span> <span class="va">stan_df_1</span>, </span>
<span>                      draws <span class="op">=</span> <span class="va">parameter_draws_1</span>, </span>
<span>                      cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/loo.html">loo_i</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span>, <span class="va">llfun_logistic</span>, r_eff <span class="op">=</span> <span class="va">r_eff</span>, data <span class="op">=</span> <span class="va">stan_df_1</span>, draws <span class="op">=</span> <span class="va">parameter_draws_1</span><span class="op">)</span></span></code></pre></div>
<pre><code>$pointwise
    elpd_loo mcse_elpd_loo        p_loo     looic influence_pareto_k
1 -0.3314552  0.0002887608 0.0003361772 0.6629103        -0.05679886
...</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="approximate-loo-cv-using-psis-loo-and-subsampling">Approximate LOO-CV using PSIS-LOO and subsampling<a class="anchor" aria-label="anchor" href="#approximate-loo-cv-using-psis-loo-and-subsampling"></a>
</h2>
<p>We can then use the <code><a href="../reference/loo_subsample.html">loo_subsample()</a></code> function to compute
the efficient PSIS-LOO approximation to exact LOO-CV using
subsampling:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">4711</span><span class="op">)</span></span>
<span><span class="va">loo_ss_1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/loo_subsample.html">loo_subsample</a></span><span class="op">(</span></span>
<span>    <span class="va">llfun_logistic</span>,</span>
<span>    observations <span class="op">=</span> <span class="fl">100</span>, <span class="co"># take a subsample of size 100</span></span>
<span>    cores <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    <span class="co"># these next objects were computed above</span></span>
<span>    r_eff <span class="op">=</span> <span class="va">r_eff</span>, </span>
<span>    draws <span class="op">=</span> <span class="va">parameter_draws_1</span>,</span>
<span>    data <span class="op">=</span> <span class="va">stan_df_1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_ss_1</span><span class="op">)</span></span></code></pre></div>
<pre><code>Computed from 4000 by 100 subsampled log-likelihood
values from 3020 total observations.

         Estimate   SE subsampling SE
elpd_loo  -1968.5 15.6            0.3
p_loo         3.1  0.1            0.4
looic      3936.9 31.2            0.6
------
Monte Carlo SE of elpd_loo is 0.0.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.9, 1.0]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
<p>The <code><a href="../reference/loo_subsample.html">loo_subsample()</a></code> function creates an object of class
<code>psis_loo_ss</code>, that inherits from <code>psis_loo, loo</code>
(the classes of regular <code>loo</code> objects).</p>
<p>The printed output above shows the estimates <span class="math inline">$\widehat{\mbox{elpd}}_{\rm loo}$</span> (expected
log predictive density), <span class="math inline">$\widehat{p}_{\rm
loo}$</span> (effective number of parameters), and <span class="math inline">${\rm looic} =-2\,
\widehat{\mbox{elpd}}_{\rm loo}$</span> (the LOO information criterion).
Unlike when using <code><a href="../reference/loo.html">loo()</a></code>, when using
<code><a href="../reference/loo_subsample.html">loo_subsample()</a></code> there is an additional column giving the
“subsampling SE”, which reflects the additional uncertainty due to the
subsampling used.</p>
<p>The line at the bottom of the printed output provides information
about the reliability of the LOO approximation (the interpretation of
the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
parameter is explained in <code><a href="../reference/pareto-k-diagnostic.html">help('pareto-k-diagnostic')</a></code> and
in greater detail in Vehtari, Simpson, Gelman, Yao, and Gabry (2019)).
In this case, the message tells us that all of the estimates for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
are fine <em>for this given subsample</em>.</p>
<div class="section level3">
<h3 id="adding-additional-subsamples">Adding additional subsamples<a class="anchor" aria-label="anchor" href="#adding-additional-subsamples"></a>
</h3>
<p>If we are not satisfied with the subsample size (i.e., the accuracy)
we can simply add more samples until we are satisfied using the
<code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code> method.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">4711</span><span class="op">)</span></span>
<span><span class="va">loo_ss_1b</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>    <span class="va">loo_ss_1</span>,</span>
<span>    observations <span class="op">=</span> <span class="fl">200</span>, <span class="co"># subsample 200 instead of 100</span></span>
<span>    r_eff <span class="op">=</span> <span class="va">r_eff</span>,</span>
<span>    draws <span class="op">=</span> <span class="va">parameter_draws_1</span>,</span>
<span>    data <span class="op">=</span> <span class="va">stan_df_1</span></span>
<span>  <span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_ss_1b</span><span class="op">)</span></span></code></pre></div>
<pre><code>Computed from 4000 by 200 subsampled log-likelihood
values from 3020 total observations.

         Estimate   SE subsampling SE
elpd_loo  -1968.3 15.6            0.2
p_loo         3.2  0.1            0.4
looic      3936.7 31.2            0.5
------
Monte Carlo SE of elpd_loo is 0.0.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.9, 1.0]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<div class="section level3">
<h3 id="specifying-estimator-and-sampling-method">Specifying estimator and sampling method<a class="anchor" aria-label="anchor" href="#specifying-estimator-and-sampling-method"></a>
</h3>
<p>The performance relies on two components: the estimation method and
the approximation used for the elpd. See the documentation for
<code><a href="../reference/loo_subsample.html">loo_subsample()</a></code> more information on which estimators and
approximations are implemented. The default implementation is using the
point log predictive density evaluated at the mean of the posterior
(<code>loo_approximation="plpd"</code>) and the difference estimator
(<code>estimator="diff_srs"</code>). This combination has a focus on
fast inference. But we can easily use other estimators as well as other
elpd approximations, for example:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">4711</span><span class="op">)</span></span>
<span><span class="va">loo_ss_1c</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/loo_subsample.html">loo_subsample</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">llfun_logistic</span>,</span>
<span>    r_eff <span class="op">=</span> <span class="va">r_eff</span>,</span>
<span>    draws <span class="op">=</span> <span class="va">parameter_draws_1</span>,</span>
<span>    data <span class="op">=</span> <span class="va">stan_df_1</span>,</span>
<span>    observations <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    estimator <span class="op">=</span> <span class="st">"hh_pps"</span>, <span class="co"># use Hansen-Hurwitz</span></span>
<span>    loo_approximation <span class="op">=</span> <span class="st">"lpd"</span>, <span class="co"># use lpd instead of plpd</span></span>
<span>    loo_approximation_draws <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    cores <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_ss_1c</span><span class="op">)</span></span></code></pre></div>
<pre><code>Computed from 4000 by 100 subsampled log-likelihood
values from 3020 total observations.

         Estimate   SE subsampling SE
elpd_loo  -1968.9 15.4            0.5
p_loo         3.5  0.2            0.5
looic      3937.9 30.7            1.1
------
Monte Carlo SE of elpd_loo is 0.0.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.9, 1.0]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
<p>See the documentation and references for <code><a href="../reference/loo_subsample.html">loo_subsample()</a></code>
for details on the implemented approximations.</p>
</div>
</div>
<div class="section level2">
<h2 id="approximate-loo-cv-using-psis-loo-with-posterior-approximations">Approximate LOO-CV using PSIS-LOO with posterior approximations<a class="anchor" aria-label="anchor" href="#approximate-loo-cv-using-psis-loo-with-posterior-approximations"></a>
</h2>
<p>Using posterior approximations, such as variational inference and
Laplace approximations, can further speed-up LOO-CV for large data. Here
we demonstrate using a Laplace approximation in Stan.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_laplace</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-optimizing.html" class="external-link">optimizing</a></span><span class="op">(</span><span class="va">stan_mod</span>, data <span class="op">=</span> <span class="va">standata</span>, draws <span class="op">=</span> <span class="fl">2000</span>, </span>
<span>                          importance_resampling <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">parameter_draws_laplace</span> <span class="op">&lt;-</span> <span class="va">fit_laplace</span><span class="op">$</span><span class="va">theta_tilde</span> <span class="co"># draws from approximate posterior</span></span>
<span><span class="va">log_p</span> <span class="op">&lt;-</span> <span class="va">fit_laplace</span><span class="op">$</span><span class="va">log_p</span> <span class="co"># log density of the posterior</span></span>
<span><span class="va">log_g</span> <span class="op">&lt;-</span> <span class="va">fit_laplace</span><span class="op">$</span><span class="va">log_g</span> <span class="co"># log density of the approximation</span></span></code></pre></div>
<p>Using the posterior approximation we can then do LOO-CV by correcting
for the posterior approximation when we compute the elpd. To do this we
use the <code><a href="../reference/loo_approximate_posterior.html">loo_approximate_posterior()</a></code> function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">4711</span><span class="op">)</span></span>
<span><span class="va">loo_ap_1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/loo_approximate_posterior.html">loo_approximate_posterior</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">llfun_logistic</span>,</span>
<span>    draws <span class="op">=</span> <span class="va">parameter_draws_laplace</span>,</span>
<span>    data <span class="op">=</span> <span class="va">stan_df_1</span>,</span>
<span>    log_p <span class="op">=</span> <span class="va">log_p</span>,</span>
<span>    log_g <span class="op">=</span> <span class="va">log_g</span>,</span>
<span>    cores <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_ap_1</span><span class="op">)</span></span></code></pre></div>
<p>The function creates a class, <code>psis_loo_ap</code> that inherits
from <code>psis_loo, loo</code>.</p>
<pre><code>Computed from 2000 by 3020 log-likelihood matrix

         Estimate   SE
elpd_loo  -1968.4 15.6
p_loo         3.2  0.2
looic      3936.8 31.2
------
Posterior approximation correction used.
Monte Carlo SE of elpd_loo is 0.0.
MCSE and ESS estimates assume independent draws (r_eff=1).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
<div class="section level3">
<h3 id="combining-the-posterior-approximation-method-with-subsampling">Combining the posterior approximation method with subsampling<a class="anchor" aria-label="anchor" href="#combining-the-posterior-approximation-method-with-subsampling"></a>
</h3>
<p>The posterior approximation correction can also be used together with
subsampling:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">4711</span><span class="op">)</span></span>
<span><span class="va">loo_ap_ss_1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/loo_subsample.html">loo_subsample</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">llfun_logistic</span>,</span>
<span>    draws <span class="op">=</span> <span class="va">parameter_draws_laplace</span>,</span>
<span>    data <span class="op">=</span> <span class="va">stan_df_1</span>,</span>
<span>    log_p <span class="op">=</span> <span class="va">log_p</span>,</span>
<span>    log_g <span class="op">=</span> <span class="va">log_g</span>,</span>
<span>    observations <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    cores <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_ap_ss_1</span><span class="op">)</span></span></code></pre></div>
<pre><code>Computed from 2000 by 100 subsampled log-likelihood
values from 3020 total observations.

         Estimate   SE subsampling SE
elpd_loo  -1968.2 15.6            0.4
p_loo         2.9  0.1            0.5
looic      3936.4 31.1            0.8
------
Posterior approximation correction used.
Monte Carlo SE of elpd_loo is 0.0.
MCSE and ESS estimates assume independent draws (r_eff=1).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
<p>The object created is of class <code>psis_loo_ss</code>, which
inherits from the <code>psis_loo_ap</code> class previously
described.</p>
</div>
<div class="section level3">
<h3 id="comparing-models">Comparing models<a class="anchor" aria-label="anchor" href="#comparing-models"></a>
</h3>
<p>To compare this model to an alternative model for the same data we
can use the <code><a href="../reference/loo_compare.html">loo_compare()</a></code> function just as we would if
using <code><a href="../reference/loo.html">loo()</a></code> instead of <code><a href="../reference/loo_subsample.html">loo_subsample()</a></code> or
<code><a href="../reference/loo_approximate_posterior.html">loo_approximate_posterior()</a></code>. First we’ll fit a second model
to the well-switching data, using <code>log(arsenic)</code> instead of
<code>arsenic</code> as a predictor:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">standata</span><span class="op">$</span><span class="va">X</span><span class="op">[</span>, <span class="st">"arsenic"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">standata</span><span class="op">$</span><span class="va">X</span><span class="op">[</span>, <span class="st">"arsenic"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">fit_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span><span class="va">stan_mod</span>, data <span class="op">=</span> <span class="va">standata</span><span class="op">)</span> </span>
<span><span class="va">parameter_draws_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit_2</span><span class="op">)</span><span class="op">$</span><span class="va">beta</span></span>
<span><span class="va">stan_df_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">standata</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># recompute subsampling loo for first model for demonstration purposes</span></span>
<span></span>
<span><span class="co"># compute relative efficiency (this is slow and optional but is recommended to allow </span></span>
<span><span class="co"># for adjusting PSIS effective sample size based on MCMC effective sample size)</span></span>
<span><span class="va">r_eff_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/relative_eff.html">relative_eff</a></span><span class="op">(</span></span>
<span>  <span class="va">llfun_logistic</span>,</span>
<span>  log <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># relative_eff wants likelihood not log-likelihood values</span></span>
<span>  chain_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, each <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">stan_df_1</span>,</span>
<span>  draws <span class="op">=</span> <span class="va">parameter_draws_1</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">4711</span><span class="op">)</span></span>
<span><span class="va">loo_ss_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo_subsample.html">loo_subsample</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">llfun_logistic</span>,</span>
<span>  r_eff <span class="op">=</span> <span class="va">r_eff_1</span>,</span>
<span>  draws <span class="op">=</span> <span class="va">parameter_draws_1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">stan_df_1</span>,</span>
<span>  observations <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># compute subsampling loo for a second model (with log-arsenic)</span></span>
<span></span>
<span><span class="va">r_eff_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/relative_eff.html">relative_eff</a></span><span class="op">(</span></span>
<span>  <span class="va">llfun_logistic</span>,</span>
<span>  log <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># relative_eff wants likelihood not log-likelihood values</span></span>
<span>  chain_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, each <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">stan_df_2</span>,</span>
<span>  draws <span class="op">=</span> <span class="va">parameter_draws_2</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="va">loo_ss_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo_subsample.html">loo_subsample</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">llfun_logistic</span>,</span>
<span>  r_eff <span class="op">=</span> <span class="va">r_eff_2</span>, </span>
<span>  draws <span class="op">=</span> <span class="va">parameter_draws_2</span>,</span>
<span>  data <span class="op">=</span> <span class="va">stan_df_2</span>,</span>
<span>  observations <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_ss_2</span><span class="op">)</span></span></code></pre></div>
<pre><code>Computed from 4000 by 100 subsampled log-likelihood
values from 3020 total observations.

         Estimate   SE subsampling SE
elpd_loo  -1952.0 16.2            0.2
p_loo         2.6  0.1            0.3
looic      3903.9 32.4            0.4
------
Monte Carlo SE of elpd_loo is 0.0.
MCSE and ESS estimates assume MCMC draws (r_eff in [1.0, 1.1]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
<p>We can now compare the models on LOO using the
<code>loo_compare</code> function:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare</span></span>
<span><span class="va">comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">loo_ss_1</span>, <span class="va">loo_ss_2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">comp</span><span class="op">)</span></span></code></pre></div>
<pre><code>Warning: Different subsamples in 'model2' and 'model1'. Naive diff SE is used.

       elpd_diff se_diff subsampling_se_diff
model2  0.0       0.0     0.0               
model1 16.5      22.5     0.4               </code></pre>
<p>This new object <code>comp</code> contains the estimated difference
of expected leave-one-out prediction errors between the two models,
along with the standard error. As the warning indicates, because
different subsamples were used the comparison will not take the
correlations between different observations into account. Here we see
that the naive SE is 22.5 and we cannot see any difference in
performance between the models.</p>
<p>To force subsampling to use the same observations for each of the
models we can simply extract the observations used in
<code>loo_ss_1</code> and use them in <code>loo_ss_2</code> by supplying
the <code>loo_ss_1</code> object to the <code>observations</code>
argument.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo_ss_2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/loo_subsample.html">loo_subsample</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">llfun_logistic</span>,</span>
<span>    r_eff <span class="op">=</span> <span class="va">r_eff_2</span>,</span>
<span>    draws <span class="op">=</span> <span class="va">parameter_draws_2</span>,</span>
<span>    data <span class="op">=</span> <span class="va">stan_df_2</span>,</span>
<span>    observations <span class="op">=</span> <span class="va">loo_ss_1</span>,</span>
<span>    cores <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We could also supply the subsampling indices using the
<code><a href="../reference/obs_idx.html">obs_idx()</a></code> helper function:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/obs_idx.html">obs_idx</a></span><span class="op">(</span><span class="va">loo_ss_1</span><span class="op">)</span></span>
<span><span class="va">loo_ss_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo_subsample.html">loo_subsample</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">llfun_logistic</span>,</span>
<span>  r_eff <span class="op">=</span> <span class="va">r_eff_2</span>, </span>
<span>  draws <span class="op">=</span> <span class="va">parameter_draws_2</span>,</span>
<span>  data <span class="op">=</span> <span class="va">stan_df_2</span>,</span>
<span>  observations <span class="op">=</span> <span class="va">idx</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>Simple random sampling with replacement assumed.</code></pre>
<p>This results in a message indicating that we assume these
observations to have been sampled with simple random sampling, which is
true because we had used the default <code>"diff_srs"</code> estimator
for <code>loo_ss_1</code>.</p>
<p>We can now compare the models and estimate the difference based on
the same subsampled observations.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">loo_ss_1</span>, <span class="va">loo_ss_2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">comp</span><span class="op">)</span> </span></code></pre></div>
<pre><code>       elpd_diff se_diff subsampling_se_diff
model2  0.0       0.0     0.0               
model1 16.1       4.4     0.1               </code></pre>
<p>First, notice that now the <code>se_diff</code> is now around 4 (as
opposed to 20 when using different subsamples). The first column shows
the difference in ELPD relative to the model with the largest ELPD. In
this case, the difference in <code>elpd</code> and its scale relative to
the approximate standard error of the difference) indicates a preference
for the second model (<code>model2</code>). Since the subsampling
uncertainty is so small in this case it can effectively be ignored. If
we need larger subsamples we can simply add samples using the
<code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code> method demonstrated earlier.</p>
<p>It is also possible to compare a subsampled loo computation with a
full loo object.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># use loo() instead of loo_subsample() to compute full PSIS-LOO for model 2</span></span>
<span><span class="va">loo_full_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">llfun_logistic</span>,</span>
<span>  r_eff <span class="op">=</span> <span class="va">r_eff_2</span>,</span>
<span>  draws <span class="op">=</span> <span class="va">parameter_draws_2</span>,</span>
<span>  data <span class="op">=</span> <span class="va">stan_df_2</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">loo_ss_1</span>, <span class="va">loo_full_2</span><span class="op">)</span></span></code></pre></div>
<pre><code>Estimated elpd_diff using observations included in loo calculations for all models.</code></pre>
<p>Because we are comparing a non-subsampled loo calculation to a
subsampled calculation we get the message that only the observations
that are included in the loo calculations for both <code>model1</code>
and <code>model2</code> are included in the computations for the
comparison.</p>
<pre><code>       elpd_diff se_diff subsampling_se_diff
model2  0.0       0.0     0.0               
model1 16.3       4.4     0.3   </code></pre>
<p>Here we actually see an increase in <code>subsampling_se_diff</code>,
but this is due to a technical detail not elaborated here. In general,
the difference should be better or negligible.</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Gelman, A., and Hill, J. (2007). <em>Data Analysis Using Regression
and Multilevel Hierarchical Models.</em> Cambridge University Press.</p>
<p>Stan Development Team (2017). <em>The Stan C++ Library, Version
2.17.0.</em> <a href="https://mc-stan.org/" class="external-link uri">https://mc-stan.org/</a></p>
<p>Stan Development Team (2018) <em>RStan: the R interface to Stan,
Version 2.17.3.</em> <a href="https://mc-stan.org/" class="external-link uri">https://mc-stan.org/</a></p>
<p>Magnusson, M., Riis Andersen, M., Jonasson, J. and Vehtari, A.
(2020). Leave-One-Out Cross-Validation for Model Comparison in Large
Data. Proceedings of the 23rd International Conference on Artificial
Intelligence and Statistics (AISTATS), in PMLR 108. <a href="https://arxiv.org/abs/2001.00980" class="external-link">arXiv preprint
arXiv:2001.00980</a>.</p>
<p>Magnusson, M., Andersen, M., Jonasson, J. &amp; Vehtari, A. (2019).
Bayesian leave-one-out cross-validation for large data. Proceedings of
the 36th International Conference on Machine Learning, in PMLR
97:4244-4253 <a href="http://proceedings.mlr.press/v97/magnusson19a.html" class="external-link">online</a>, <a href="https://arxiv.org/abs/1904.10679" class="external-link">arXiv preprint
arXiv:1904.10679</a>.</p>
<p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical Bayesian
model evaluation using leave-one-out cross-validation and WAIC.
<em>Statistics and Computing</em>. 27(5), 1413–1432.
:10.1007/s11222-016-9696-4. <a href="https://link.springer.com/article/10.1007/s11222-016-9696-4" class="external-link">online</a>,
<a href="https://arxiv.org/abs/1507.04544" class="external-link">arXiv preprint
arXiv:1507.04544</a>.</p>
<p>Vehtari, A., Simpson, D., Gelman, A., Yao, Y., and Gabry, J. (2024).
Pareto smoothed importance sampling. <em>Journal of Machine Learning
Research</em>, 25(72):1-58. <a href="https://jmlr.org/papers/v25/19-556.html" class="external-link">PDF</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Aki Vehtari, Jonah Gabry, Måns Magnusson, Yuling Yao, Paul-Christian Bürkner, Topi Paananen, Andrew Gelman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
