<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- upstream: inst/BS5/templates/head.html; pkgdown-version: 2.1.3, fe04924 --><!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 --><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Avoiding model refits in leave-one-out cross-validation with moment matching • loo</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_3-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- Font Awesome 7.0.1 for Bluesky icon --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" referrerpolicy="no-referrer">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Avoiding model refits in leave-one-out cross-validation with moment matching">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <!-- upstream: inst/BS5/templates/navbar.html; pkgdown-version: 2.1.3, fe04924 -->
<!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 -->
<nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">


    <a class="navbar-brand me-2" href="../index.html">
      <!-- Add Stan logo -->
      <picture><source type="image/svg+xml" srcset="../logo.svg"><img src="../logo.png" class="stan-logo" alt="Stan blue hex logo"></source></picture>
      loo
    </a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.8.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-other-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Other Packages</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-other-packages">
<li><a class="external-link dropdown-item" href="https://mc-stan.org/bayesplot">bayesplot</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/cmdstanr">cmdstanr</a></li>
    <li><a class="dropdown-item" href="https://mc-stan.org/loo">loo</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/posterior">posterior</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/projpred">projpred</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstan">rstan</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstanarm">rstanarm</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstantools">rstantools</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/shinystan">shinystan</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mc-stan.org/about/">About Stan</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/did:plc:qznndgdnkem2yryu7ipqbpv7" aria-label="Visit our Bluesky profile"><span class="fa fa-brands fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/mcmc_stan" aria-label="Visit our Twitter profile"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://discourse.mc-stan.org/" aria-label="Visit our forums"><span class="fa fa-users"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stan-dev/loo/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Avoiding model refits in leave-one-out cross-validation with moment matching</h1>
                        <h4 data-toc-skip class="author">Topi Paananen,
Paul Bürkner, Aki Vehtari and Jonah Gabry</h4>
            
            <h4 data-toc-skip class="date">2025-09-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/loo/blob/HEAD/vignettes/loo2-moment-matching.Rmd" class="external-link"><code>vignettes/loo2-moment-matching.Rmd</code></a></small>
      <div class="d-none name"><code>loo2-moment-matching.Rmd</code></div>
    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Avoiding model refits in leave-one-out cross-validation with moment matching}
-->
<p><strong>NOTE: We recommend viewing the fully rendered version of this
vignette online at <a href="https://mc-stan.org/loo/articles/" class="uri">https://mc-stan.org/loo/articles/</a></strong></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette demonstrates how to improve the Monte Carlo sampling
accuracy of leave-one-out cross-validation with the <strong>loo</strong>
package and Stan. The <strong>loo</strong> package automatically
monitors the sampling accuracy using Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
diagnostics for each observation. Here, we present a method for quickly
improving the accuracy when the Pareto diagnostics indicate problems.
This is done by performing some additional computations using the
existing posterior sample. If successful, this will decrease the Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
values, making the model assessment more reliable. <strong>loo</strong>
also stores the original Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
values with the name <code>influence_pareto_k</code> which are not
changed. They can be used as a diagnostic of how much each observation
influences the posterior distribution.</p>
<p>The methodology presented is based on the paper</p>
<ul>
<li>Paananen, T., Piironen, J., Buerkner, P.-C., Vehtari, A. (2020).
Implicitly Adaptive Importance Sampling. <a href="https://arxiv.org/abs/1906.08850" class="external-link">arXiv preprint
arXiv:1906.08850</a>.</li>
</ul>
<p>More information about the Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
diagnostics is given in the following papers</p>
<ul>
<li><p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical Bayesian
model evaluation using leave-one-out cross-validation and WAIC.
<em>Statistics and Computing</em>. 27(5), 1413–1432.
:10.1007/s11222-016-9696-4. Links: <a href="https://link.springer.com/article/10.1007/s11222-016-9696-4" class="external-link">published</a>
| <a href="https://arxiv.org/abs/1507.04544" class="external-link">arXiv
preprint</a>.</p></li>
<li><p>Vehtari, A., Simpson, D., Gelman, A., Yao, Y., and Gabry, J.
(2024). Pareto smoothed importance sampling. <em>Journal of Machine
Learning Research</em>, 25(72):1-58. <a href="https://jmlr.org/papers/v25/19-556.html" class="external-link">PDF</a></p></li>
</ul>
</div>
<div class="section level2">
<h2 id="example-eradication-of-roaches">Example: Eradication of Roaches<a class="anchor" aria-label="anchor" href="#example-eradication-of-roaches"></a>
</h2>
<p>We will use the same example as in the vignette <a href="https://mc-stan.org/loo/articles/loo2-example.html"><em>Using the
loo package (version &gt;= 2.0.0)</em></a>. See the demo for a
description of the problem and data. We will use the same Poisson
regression model as in the case study.</p>
<div class="section level3">
<h3 id="coding-the-stan-model">Coding the Stan model<a class="anchor" aria-label="anchor" href="#coding-the-stan-model"></a>
</h3>
<p>Here is the Stan code for fitting the Poisson regression model, which
we will use for modeling the number of roaches.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note: some syntax used in this Stan program requires RStan &gt;= 2.26 (or CmdStanR)</span></span>
<span><span class="co"># To use an older version of RStan change the line declaring `y` to: int y[N];</span></span>
<span><span class="va">stancode</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">data {</span></span>
<span><span class="st">  int&lt;lower=1&gt; K;</span></span>
<span><span class="st">  int&lt;lower=1&gt; N;</span></span>
<span><span class="st">  matrix[N,K] x;</span></span>
<span><span class="st">  array[N] int y;</span></span>
<span><span class="st">  vector[N] offset;</span></span>
<span><span class="st"></span></span>
<span><span class="st">  real beta_prior_scale;</span></span>
<span><span class="st">  real alpha_prior_scale;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">parameters {</span></span>
<span><span class="st">  vector[K] beta;</span></span>
<span><span class="st">  real intercept;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">model {</span></span>
<span><span class="st">  y ~ poisson(exp(x * beta + intercept + offset));</span></span>
<span><span class="st">  beta ~ normal(0,beta_prior_scale);</span></span>
<span><span class="st">  intercept ~ normal(0,alpha_prior_scale);</span></span>
<span><span class="st">}</span></span>
<span><span class="st">generated quantities {</span></span>
<span><span class="st">  vector[N] log_lik;</span></span>
<span><span class="st">  for (n in 1:N)</span></span>
<span><span class="st">    log_lik[n] = poisson_lpmf(y[n] | exp(x[n] * beta + intercept + offset[n]));</span></span>
<span><span class="st">}</span></span>
<span><span class="st">"</span></span></code></pre></div>
<p>Following the usual approach recommended in <a href="http://mc-stan.org/loo/articles/loo2-with-rstan.html" class="external-link"><em>Writing
Stan programs for use with the loo package</em></a>, we compute the
log-likelihood for each observation in the
<code>generated quantities</code> block of the Stan program.</p>
</div>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<p>In addition to <strong>loo</strong>, we load the
<strong>rstan</strong> package for fitting the model, and the
<strong>rstanarm</strong> package for the data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mc-stan.org/rstan/" class="external-link">"rstan"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mc-stan.org/loo/">"loo"</a></span><span class="op">)</span></span>
<span><span class="va">seed</span> <span class="op">&lt;-</span> <span class="fl">9547</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fitting-the-model-with-rstan">Fitting the model with RStan<a class="anchor" aria-label="anchor" href="#fitting-the-model-with-rstan"></a>
</h3>
<p>Next we fit the model in Stan using the <strong>rstan</strong>
package:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">roaches</span>, package <span class="op">=</span> <span class="st">"rstanarm"</span><span class="op">)</span></span>
<span><span class="va">roaches</span><span class="op">$</span><span class="va">roach1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">$</span><span class="va">roach1</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">roaches</span><span class="op">$</span><span class="va">y</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">roaches</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"roach1"</span>, <span class="st">"treatment"</span>, <span class="st">"senior"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span>,<span class="st">"exposure2"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="va">standata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="va">n</span>, K <span class="op">=</span> <span class="va">k</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">y</span>, offset <span class="op">=</span> <span class="va">offset</span>, beta_prior_scale <span class="op">=</span> <span class="fl">2.5</span>, alpha_prior_scale <span class="op">=</span> <span class="fl">5.0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compile</span></span>
<span><span class="va">stanmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span>model_code <span class="op">=</span> <span class="va">stancode</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit model</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span><span class="va">stanmodel</span>, data <span class="op">=</span> <span class="va">standata</span>, seed <span class="op">=</span> <span class="va">seed</span>, refresh <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span></span></code></pre></div>
<p>Let us now evaluate the predictive performance of the model using
<code><a href="../reference/loo.html">loo()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">loo1</span></span></code></pre></div>
<p>The <code><a href="../reference/loo.html">loo()</a></code> function output warnings that there are some
observations which are highly influential, and thus the accuracy of
importance sampling is compromised as indicated by the large Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
diagnostic values (&gt; 0.7). As discussed in the vignette <a href="https://mc-stan.org/loo/articles/loo2-example.html"><em>Using the
loo package (version &gt;= 2.0.0)</em></a>, this may be an indication of
model misspecification. Despite that, it is still beneficial to be able
to evaluate the predictive performance of the model accurately.</p>
</div>
<div class="section level3">
<h3 id="moment-matching-correction-for-importance-sampling">Moment matching correction for importance sampling<a class="anchor" aria-label="anchor" href="#moment-matching-correction-for-importance-sampling"></a>
</h3>
<p>To improve the accuracy of the <code><a href="../reference/loo.html">loo()</a></code> result above, we
could perform leave-one-out cross-validation by explicitly leaving out
single observations and refitting the model using MCMC repeatedly.
However, the Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
diagnostics indicate that there are 19 observations which are
problematic. This would require 19 model refits which may require a lot
of computation time.</p>
<p>Instead of refitting with MCMC, we can perform a faster moment
matching correction to the importance sampling for the problematic
observations. This can be done with the <code><a href="../reference/loo_moment_match.html">loo_moment_match()</a></code>
function in the <strong>loo</strong> package, which takes our existing
<code>loo</code> object as input and modifies it. The moment matching
requires some evaluations of the model posterior density. For models
fitted with <strong>rstan</strong>, this can be conveniently done by
using the existing <code>stanfit</code> object.</p>
<p>First, we show how the moment matching can be used for a model fitted
using <strong>rstan</strong>. It only requires setting the argument
<code>moment_match</code> to <code>TRUE</code> in the <code><a href="../reference/loo.html">loo()</a></code>
function. Optionally, you can also set the argument
<code>k_threshold</code> which determines the Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
threshold, above which moment matching is used. By default, it operates
on all observations whose Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
value is larger than the sample size
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>)
specific threshold
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>min</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mn>1</mn><mi>/</mi><msub><mo>log</mo><mn>10</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>S</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mn>0.7</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\min(1 - 1 / \log_{10}(S), 0.7)</annotation></semantics></math>
(which is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0.7</mn><annotation encoding="application/x-tex">0.7</annotation></semantics></math>
for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>&gt;</mo><mn>2200</mn></mrow><annotation encoding="application/x-tex">S&gt;2200</annotation></semantics></math>).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># available in rstan &gt;= 2.21</span></span>
<span><span class="va">loo2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">fit</span>, moment_match <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">loo2</span></span></code></pre></div>
<p>After the moment matching, all observations have the diagnostic
Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
less than 0.7, meaning that the estimates are now reliable. The total
<code>elpd_loo</code> estimate also changed from <code>-5457.8</code> to
<code>-5478.5</code>, showing that before moment matching,
<code><a href="../reference/loo.html">loo()</a></code> overestimated the predictive performance of the
model.</p>
<p>The updated Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
values stored in <code>loo2$diagnostics$pareto_k</code> are considered
algorithmic diagnostic values that indicate the sampling accuracy. The
original Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
values are stored in <code>loo2$pointwise[,"influence_pareto_k"]</code>
and these are not modified by the moment matching. These can be
considered as diagnostics for how big influence each observation has on
the posterior distribution. In addition to the Pareto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
diagnostics, moment matching also updates the effective sample size
estimates.</p>
</div>
</div>
<div class="section level2">
<h2 id="using-loo_moment_match-directly">Using <code>loo_moment_match()</code> directly<a class="anchor" aria-label="anchor" href="#using-loo_moment_match-directly"></a>
</h2>
<p>The moment matching can also be performed by explicitly calling the
function <code><a href="../reference/loo_moment_match.html">loo_moment_match()</a></code>. This enables its use also for
models that are not using <strong>rstan</strong> or another package with
built-in support for <code><a href="../reference/loo_moment_match.html">loo_moment_match()</a></code>. To use
<code><a href="../reference/loo_moment_match.html">loo_moment_match()</a></code>, the user must give the model object
<code>x</code>, the <code>loo</code> object, and 5 helper functions as
arguments to <code><a href="../reference/loo_moment_match.html">loo_moment_match()</a></code>. The helper functions
are</p>
<ul>
<li>
<code>post_draws</code>
<ul>
<li>A function the takes <code>x</code> as the first argument and
returns a matrix of posterior draws of the model parameters,
<code>pars</code>.</li>
</ul>
</li>
<li>
<code>log_lik_i</code>
<ul>
<li>A function that takes <code>x</code> and <code>i</code> and returns
a matrix (one column per chain) or a vector (all chains stacked) of
log-likeliood draws of the ith observation based on the model
<code>x</code>. If the draws are obtained using MCMC, the matrix with
MCMC chains separated is preferred.</li>
</ul>
</li>
<li>
<code>unconstrain_pars</code>
<ul>
<li>A function that takes arguments <code>x</code> and
<code>pars</code>, and returns posterior draws on the unconstrained
space based on the posterior draws on the constrained space passed via
<code>pars</code>.</li>
</ul>
</li>
<li>
<code>log_prob_upars</code>
<ul>
<li>A function that takes arguments <code>x</code> and
<code>upars</code>, and returns a matrix of log-posterior density values
of the unconstrained posterior draws passed via <code>upars</code>.</li>
</ul>
</li>
<li>
<code>log_lik_i_upars</code>
<ul>
<li>A function that takes arguments <code>x</code>, <code>upars</code>,
and <code>i</code> and returns a vector of log-likelihood draws of the
<code>i</code>th observation based on the unconstrained posterior draws
passed via <code>upars</code>.</li>
</ul>
</li>
</ul>
<p>Next, we show how the helper functions look like for RStan objects,
and show an example of using <code><a href="../reference/loo_moment_match.html">loo_moment_match()</a></code> directly.
For stanfit objects from <strong>rstan</strong> objects, the functions
look like this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a named list of draws for use with rstan methods</span></span>
<span><span class="va">.rstan_relist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">skeleton</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/relist.html" class="external-link">relist</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">skeleton</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">skeleton</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">skeleton</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># rstan helper function to get dims of parameters right</span></span>
<span><span class="va">.create_skeleton</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span>, <span class="va">dims</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">len_dims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dims</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">len_dims</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim <span class="op">=</span> <span class="va">dims</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">pars</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># extract original posterior draws</span></span>
<span><span class="va">post_draws_stanfit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># compute a matrix of log-likelihood values for the ith observation</span></span>
<span><span class="co"># matrix contains information about the number of MCMC chains</span></span>
<span><span class="va">log_lik_i_stanfit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">i</span>, <span class="va">parameter_name</span> <span class="op">=</span> <span class="st">"log_lik"</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="../reference/extract_log_lik.html">extract_log_lik</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">parameter_name</span>, merge_chains <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">[</span>, , <span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># transform parameters to the unconstraint space</span></span>
<span><span class="va">unconstrain_pars_stanfit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">pars</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">skeleton</span> <span class="op">&lt;-</span> <span class="fu">.create_skeleton</span><span class="op">(</span><span class="va">x</span><span class="op">@</span><span class="va">sim</span><span class="op">$</span><span class="va">pars_oi</span>, <span class="va">x</span><span class="op">@</span><span class="va">par_dims</span><span class="op">[</span><span class="va">x</span><span class="op">@</span><span class="va">sim</span><span class="op">$</span><span class="va">pars_oi</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">upars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pars</span>, <span class="fl">1</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-logprob.html" class="external-link">unconstrain_pars</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu">.rstan_relist</span><span class="op">(</span><span class="va">theta</span>, <span class="va">skeleton</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="co"># for one parameter models</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">upars</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">upars</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">upars</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">upars</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># compute log_prob for each posterior draws on the unconstrained space</span></span>
<span><span class="va">log_prob_upars_stanfit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">upars</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">upars</span>, <span class="fl">1</span>, <span class="fu">rstan</span><span class="fu">::</span><span class="va"><a href="https://mc-stan.org/rstan/reference/stanfit-method-logprob.html" class="external-link">log_prob</a></span>, object <span class="op">=</span> <span class="va">x</span>,</span>
<span>        adjust_transform <span class="op">=</span> <span class="cn">TRUE</span>, gradient <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># compute log_lik values based on the unconstrained parameters</span></span>
<span><span class="va">log_lik_i_upars_stanfit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">upars</span>, <span class="va">i</span>, <span class="va">parameter_name</span> <span class="op">=</span> <span class="st">"log_lik"</span>,</span>
<span>                                  <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">upars</span><span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-logprob.html" class="external-link">constrain_pars</a></span><span class="op">(</span><span class="va">x</span>, upars <span class="op">=</span> <span class="va">upars</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span><span class="op">)</span><span class="op">[[</span><span class="va">parameter_name</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Using these function, we can call <code><a href="../reference/loo_moment_match.html">loo_moment_match()</a></code> to
update the existing <code>loo</code> object.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo3</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="../reference/loo_moment_match.html">loo_moment_match.default</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">fit</span>,</span>
<span>  loo <span class="op">=</span> <span class="va">loo1</span>,</span>
<span>  post_draws <span class="op">=</span> <span class="va">post_draws_stanfit</span>,</span>
<span>  log_lik_i <span class="op">=</span> <span class="va">log_lik_i_stanfit</span>,</span>
<span>  unconstrain_pars <span class="op">=</span> <span class="va">unconstrain_pars_stanfit</span>,</span>
<span>  log_prob_upars <span class="op">=</span> <span class="va">log_prob_upars_stanfit</span>,</span>
<span>  log_lik_i_upars <span class="op">=</span> <span class="va">log_lik_i_upars_stanfit</span></span>
<span><span class="op">)</span></span>
<span><span class="va">loo3</span></span></code></pre></div>
<p>As expected, the result is identical to the previous result of
<code>loo2 &lt;- loo(fit, moment_match = TRUE)</code>.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Gelman, A., and Hill, J. (2007). <em>Data Analysis Using Regression
and Multilevel Hierarchical Models.</em> Cambridge University Press.</p>
<p>Stan Development Team (2020) <em>RStan: the R interface to Stan,
Version 2.21.1</em> <a href="https://mc-stan.org" class="external-link uri">https://mc-stan.org</a></p>
<p>Paananen, T., Piironen, J., Buerkner, P.-C., Vehtari, A. (2021).
Implicitly adaptive importance sampling. <em>Statistics and
Computing</em>, 31, 16. :10.1007/s11222-020-09982-2. arXiv preprint
arXiv:1906.08850.</p>
<p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical Bayesian
model evaluation using leave-one-out cross-validation and WAIC.
<em>Statistics and Computing</em>. 27(5), 1413–1432.
:10.1007/s11222-016-9696-4. Links: <a href="https://link.springer.com/article/10.1007/s11222-016-9696-4" class="external-link">published</a>
| <a href="https://arxiv.org/abs/1507.04544" class="external-link">arXiv preprint</a>.</p>
<p>Vehtari, A., Simpson, D., Gelman, A., Yao, Y., and Gabry, J. (2024).
Pareto smoothed importance sampling. <em>Journal of Machine Learning
Research</em>, 25(72):1-58. <a href="https://jmlr.org/papers/v25/19-556.html" class="external-link">PDF</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Aki Vehtari, Jonah Gabry, Måns Magnusson, Yuling Yao, Paul-Christian Bürkner, Topi Paananen, Andrew Gelman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
