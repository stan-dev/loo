<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- upstream: inst/BS5/templates/head.html; pkgdown-version: 2.1.3, fe04924 --><!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 --><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Leave-one-out cross-validation for non-factorized models • loo</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@4.0.0/tex-mml-chtml.js" integrity="sha256-qoRlVrS5NAnXSSSiMfFXwK8C9obG11Iybe4h2+bQYR4=" crossorigin="anonymous">
  </script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_3-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- Font Awesome 7.0.1 for Bluesky icon --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" referrerpolicy="no-referrer">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Leave-one-out cross-validation for non-factorized models">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <!-- upstream: inst/BS5/templates/navbar.html; pkgdown-version: 2.1.3, fe04924 -->
<!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 -->
<nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">


    <a class="navbar-brand me-2" href="../index.html">
      <!-- Add Stan logo -->
      <picture><source type="image/svg+xml" srcset="../logo.svg"><img src="../logo.png" class="stan-logo" alt="Stan blue hex logo"></source></picture>
      loo
    </a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.9.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Go to homepage"><span class="fa fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-other-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Other Packages</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-other-packages">
<li><a class="external-link dropdown-item" href="https://mc-stan.org/bayesplot">bayesplot</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/cmdstanr">cmdstanr</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/posterior">posterior</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/projpred">projpred</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstan">rstan</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstanarm">rstanarm</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstantools">rstantools</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/shinystan">shinystan</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://mc-stan.org/about/">About Stan</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/did:plc:qznndgdnkem2yryu7ipqbpv7" aria-label="Visit our Bluesky profile"><span class="fa fa-brands fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://discourse.mc-stan.org/" aria-label="Visit our forums"><span class="fa fa-users"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stan-dev/loo/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Leave-one-out cross-validation for non-factorized models</h1>
                        <h4 data-toc-skip class="author">Aki Vehtari,
Paul Bürkner and Jonah Gabry</h4>
            
            <h4 data-toc-skip class="date">2025-12-31</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/loo/blob/master/vignettes/loo2-non-factorized.Rmd" class="external-link"><code>vignettes/loo2-non-factorized.Rmd</code></a></small>
      <div class="d-none name"><code>loo2-non-factorized.Rmd</code></div>
    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Leave-one-out cross-validation for non-factorized models}
-->
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>When computing ELPD-based LOO-CV for a Bayesian model we need to
compute the log leave-one-out predictive densities <span class="math inline">\(\log{p(y_i | y_{-i})}\)</span> for every response
value <span class="math inline">\(y_i, \: i = 1, \ldots, N\)</span>,
where <span class="math inline">\(y_{-i}\)</span> denotes all response
values except observation <span class="math inline">\(i\)</span>. To
obtain <span class="math inline">\(p(y_i | y_{-i})\)</span>, we need to
have access to the pointwise likelihood <span class="math inline">\(p(y_i\,|\, y_{-i}, \theta)\)</span> and integrate
over the model parameters <span class="math inline">\(\theta\)</span>:</p>
<p><span class="math display">\[
p(y_i\,|\,y_{-i}) =
  \int p(y_i\,|\, y_{-i}, \theta) \, p(\theta\,|\, y_{-i}) \,d \theta
\]</span></p>
<p>Here, <span class="math inline">\(p(\theta\,|\, y_{-i})\)</span> is
the leave-one-out posterior distribution for <span class="math inline">\(\theta\)</span>, that is, the posterior
distribution for <span class="math inline">\(\theta\)</span> obtained by
fitting the model while holding out the <span class="math inline">\(i\)</span>th observation (we will later show how
refitting the model to data <span class="math inline">\(y_{-i}\)</span>
can be avoided).</p>
<p>If the observation model is formulated directly as the product of the
pointwise observation models, we call it a <em>factorized</em> model. In
this case, the likelihood is also the product of the pointwise
likelihood contributions <span class="math inline">\(p(y_i\,|\, y_{-i},
\theta)\)</span>. To better illustrate possible structures of the
observation models, we formally divide <span class="math inline">\(\theta\)</span> into two parts,
observation-specific latent variables <span class="math inline">\(f =
(f_1, \ldots, f_N)\)</span> and hyperparameters <span class="math inline">\(\psi\)</span>, so that <span class="math inline">\(p(y_i\,|\, y_{-i}, \theta) = p(y_i\,|\, y_{-i},
f_i, \psi)\)</span>. Depending on the model, one of the two parts of
<span class="math inline">\(\theta\)</span> may also be empty. In very
simple models, such as linear regression models, latent variables are
not explicitly presented and response values are conditionally
independent given <span class="math inline">\(\psi\)</span>, so that
<span class="math inline">\(p(y_i\,|\, y_{-i}, f_i, \psi) = p(y_i \,|\,
\psi)\)</span>. The full likelihood can then be written in the familiar
form</p>
<p><span class="math display">\[
p(y \,|\, \psi) = \prod_{i=1}^N p(y_i \,|\, \psi),
\]</span></p>
<p>where <span class="math inline">\(y = (y_1, \ldots, y_N)\)</span>
denotes the vector of all responses. When the likelihood factorizes this
way, the conditional pointwise log-likelihood can be obtained easily by
computing <span class="math inline">\(p(y_i\,|\, \psi)\)</span> for each
<span class="math inline">\(i\)</span> with computational cost <span class="math inline">\(O(n)\)</span>.</p>
<p>Yet, there are several reasons why a <em>non-factorized</em>
observation model may be necessary or preferred. In non-factorized
models, the joint likelihood of the response values <span class="math inline">\(p(y \,|\, \theta)\)</span> is not factorized into
observation-specific components, but rather given directly as one joint
expression. For some models, an analytic factorized formulation is
simply not available in which case we speak of a
<em>non-factorizable</em> model. Even in models whose observation model
can be factorized in principle, it may still be preferable to use a
non-factorized form for reasons of efficiency and numerical stability
(Bürkner et al. 2020).</p>
<p>Whether a non-factorized model is used by necessity or for efficiency
and stability, it comes at the cost of having no direct access to the
leave-one-out predictive densities and thus to the overall leave-one-out
predictive accuracy. In theory, we can express the observation-specific
likelihoods in terms of the joint likelihood via</p>
<p><span class="math display">\[
p(y_i \,|\, y_{i-1}, \theta) =
  \frac{p(y \,|\, \theta)}{p(y_{-i} \,|\, \theta)} =
  \frac{p(y \,|\, \theta)}{\int p(y \,|\, \theta) \, d y_i},
\]</span></p>
<p>but the expression on the right-hand side may not always have an
analytical solution. Computing <span class="math inline">\(\log p(y_i
\,|\, y_{-i},
\theta)\)</span> for non-factorized models is therefore often
impossible, or at least inefficient and numerically unstable. However,
there is a large class of multivariate normal and Student-<span class="math inline">\(t\)</span> models for which there are efficient
analytical solutions available.</p>
<p>More details can be found in our paper about LOO-CV for
non-factorized models (Bürkner, Gabry, &amp; Vehtari, 2020), which is
available as a preprint on arXiv (<a href="https://arxiv.org/abs/1810.10559" class="external-link uri">https://arxiv.org/abs/1810.10559</a>).</p>
</div>
<div class="section level2">
<h2 id="loo-cv-for-multivariate-normal-models">LOO-CV for multivariate normal models<a class="anchor" aria-label="anchor" href="#loo-cv-for-multivariate-normal-models"></a>
</h2>
<p>In this vignette, we will focus on non-factorized multivariate normal
models. Based on results of Sundararajan and Keerthi (2001), Bürkner et
al. (2020) show that, for multivariate normal models with coriance
matrix <span class="math inline">\(C\)</span>, the LOO predictive mean
and standard deviation can be computed as follows:</p>
<p><span class="math display">\[\begin{align}
  \mu_{\tilde{y},-i} &amp;= y_i-\bar{c}_{ii}^{-1} g_i \nonumber \\
  \sigma_{\tilde{y},-i} &amp;= \sqrt{\bar{c}_{ii}^{-1}},
\end{align}\]</span> where <span class="math inline">\(g_i\)</span> and
<span class="math inline">\(\bar{c}_{ii}\)</span> are <span class="math display">\[\begin{align}
  g_i &amp;= \left[C^{-1} y\right]_i \nonumber \\
  \bar{c}_{ii} &amp;= \left[C^{-1}\right]_{ii}.
\end{align}\]</span></p>
<p>Using these results, the log predictive density of the <span class="math inline">\(i\)</span>th observation is then computed as</p>
<p><span class="math display">\[
  \log p(y_i \,|\, y_{-i},\theta)
  = - \frac{1}{2}\log(2\pi)
  - \frac{1}{2}\log \sigma^2_{-i}
  - \frac{1}{2}\frac{(y_i-\mu_{-i})^2}{\sigma^2_{-i}}.
\]</span></p>
<p>Expressing this same equation in terms of <span class="math inline">\(g_i\)</span> and <span class="math inline">\(\bar{c}_{ii}\)</span>, the log predictive density
becomes:</p>
<p><span class="math display">\[
  \log p(y_i \,|\, y_{-i},\theta)
  = - \frac{1}{2}\log(2\pi)
  + \frac{1}{2}\log \bar{c}_{ii}
  - \frac{1}{2}\frac{g_i^2}{\bar{c}_{ii}}.
\]</span> (Note that Vehtari et al. (2016) has a typo in the
corresponding Equation 34.)</p>
<p>From these equations we can now derive a recipe for obtaining the
conditional pointwise log-likelihood for <em>all</em> models that can be
expressed conditionally in terms of a multivariate normal with
invertible covariance matrix <span class="math inline">\(C\)</span>.</p>
<div class="section level3">
<h3 id="approximate-loo-cv-using-integrated-importance-sampling">Approximate LOO-CV using integrated importance-sampling<a class="anchor" aria-label="anchor" href="#approximate-loo-cv-using-integrated-importance-sampling"></a>
</h3>
<p>The above LOO equations for multivariate normal models are
conditional on parameters <span class="math inline">\(\theta\)</span>.
Therefore, to obtain the leave-one-out predictive density <span class="math inline">\(p(y_i \,|\, y_{-i})\)</span> we need to integrate
over <span class="math inline">\(\theta\)</span>,</p>
<p><span class="math display">\[
p(y_i\,|\,y_{-i}) =
  \int p(y_i\,|\,y_{-i}, \theta) \, p(\theta\,|\,y_{-i}) \,d\theta.
\]</span></p>
<p>Here, <span class="math inline">\(p(\theta\,|\,y_{-i})\)</span> is
the leave-one-out posterior distribution for <span class="math inline">\(\theta\)</span>, that is, the posterior
distribution for <span class="math inline">\(\theta\)</span> obtained by
fitting the model while holding out the <span class="math inline">\(i\)</span>th observation.</p>
<p>To avoid the cost of sampling from <span class="math inline">\(N\)</span> leave-one-out posteriors, it is
possible to take the posterior draws <span class="math inline">\(\theta^{(s)}, \, s=1,\ldots,S\)</span>, from the
posterior <span class="math inline">\(p(\theta\,|\,y)\)</span>, and then
approximate the above integral using integrated importance sampling
(Vehtari et al., 2016, Section 3.6.1):</p>
<p><span class="math display">\[
p(y_i\,|\,y_{-i}) \approx
   \frac{ \sum_{s=1}^S p(y_i\,|\,y_{-i},\,\theta^{(s)}) \,w_i^{(s)}}{
\sum_{s=1}^S w_i^{(s)}},
\]</span></p>
<p>where <span class="math inline">\(w_i^{(s)}\)</span> are importance
weights. First we compute the raw importance ratios</p>
<p><span class="math display">\[
  r_i^{(s)} \propto \frac{1}{p(y_i \,|\, y_{-i}, \,\theta^{(s)})},
\]</span></p>
<p>and then stabilize them using Pareto smoothed importance sampling
(PSIS, Vehtari et al, 2019) to obtain the weights <span class="math inline">\(w_i^{(s)}\)</span>. The resulting approximation is
referred to as PSIS-LOO (Vehtari et al, 2017).</p>
</div>
<div class="section level3">
<h3 id="exact-loo-cv-with-re-fitting">Exact LOO-CV with re-fitting<a class="anchor" aria-label="anchor" href="#exact-loo-cv-with-re-fitting"></a>
</h3>
<p>In order to validate the approximate LOO procedure, and also in order
to allow exact computations to be made for a small number of
leave-one-out folds for which the Pareto <span class="math inline">\(k\)</span> diagnostic (Vehtari et al, 2024)
indicates an unstable approximation, we need to consider how we might to
do <em>exact</em> leave-one-out CV for a non-factorized model. In the
case of a Gaussian process that has the marginalization property, we
could just drop the one row and column of <span class="math inline">\(C\)</span> corresponding to the held out out
observation. This does not hold in general for multivariate normal
models, however, and to keep the original prior we may need to maintain
the full covariance matrix <span class="math inline">\(C\)</span> even
when one of the observations is left out.</p>
<p>The solution is to model <span class="math inline">\(y_i\)</span> as
a missing observation and estimate it along with all of the other model
parameters. For a conditional multivariate normal model, <span class="math inline">\(\log p(y_i\,|\,y_{-i})\)</span> can be computed as
follows. First, we model <span class="math inline">\(y_i\)</span> as
missing and denote the corresponding parameter <span class="math inline">\(y_i^{\mathrm{mis}}\)</span>. Then, we define</p>
<p><span class="math display">\[
y_{\mathrm{mis}(i)} = (y_1, \ldots, y_{i-1}, y_i^{\mathrm{mis}},
y_{i+1}, \ldots, y_N).
\]</span> to be the same as the full set of observations <span class="math inline">\(y\)</span>, except replacing <span class="math inline">\(y_i\)</span> with the parameter <span class="math inline">\(y_i^{\mathrm{mis}}\)</span>.</p>
<p>Second, we compute the LOO predictive mean and standard deviations as
above, but replace <span class="math inline">\(y\)</span> with <span class="math inline">\(y_{\mathrm{mis}(i)}\)</span> in the computation of
<span class="math inline">\(\mu_{\tilde{y},-i}\)</span>:</p>
<p><span class="math display">\[
\mu_{\tilde{y},-i} = y_{{\mathrm{mis}}(i)}-\bar{c}_{ii}^{-1}g_i,
\]</span></p>
<p>where in this case we have</p>
<p><span class="math display">\[
g_i = \left[ C^{-1} y_{\mathrm{mis}(i)} \right]_i.
\]</span></p>
<p>The conditional log predictive density is then computed with the
above <span class="math inline">\(\mu_{\tilde{y},-i}\)</span> and the
left out observation <span class="math inline">\(y_i\)</span>:</p>
<p><span class="math display">\[
  \log p(y_i\,|\,y_{-i},\theta)
  = - \frac{1}{2}\log(2\pi)
  - \frac{1}{2}\log \sigma^2_{\tilde{y},-i}
  -
\frac{1}{2}\frac{(y_i-\mu_{\tilde{y},-i})^2}{\sigma^2_{\tilde{y},-i}}.
\]</span></p>
<p>Finally, the leave-one-out predictive distribution can then be
estimated as</p>
<p><span class="math display">\[
p(y_i\,|\,y_{-i}) \approx \sum_{s=1}^S p(y_i\,|\,y_{-i},
\theta_{-i}^{(s)}),
\]</span></p>
<p>where <span class="math inline">\(\theta_{-i}^{(s)}\)</span> are
draws from the posterior distribution <span class="math inline">\(p(\theta\,|\,y_{\mathrm{mis}(i)})\)</span>.</p>
</div>
</div>
<div class="section level2">
<h2 id="lagged-sar-models">Lagged SAR models<a class="anchor" aria-label="anchor" href="#lagged-sar-models"></a>
</h2>
<p>A common non-factorized multivariate normal model is the
simultaneously autoregressive (SAR) model, which is frequently used for
spatially correlated data. The lagged SAR model is defined as</p>
<p><span class="math display">\[
y = \rho Wy + \eta + \epsilon
\]</span> or equivalently <span class="math display">\[
(I - \rho W)y = \eta + \epsilon,
\]</span> where <span class="math inline">\(\rho\)</span> is the spatial
correlation parameter and <span class="math inline">\(W\)</span> is a
user-defined weight matrix. The matrix <span class="math inline">\(W\)</span> has entries <span class="math inline">\(w_{ii} = 0\)</span> along the diagonal and the
off-diagonal entries <span class="math inline">\(w_{ij}\)</span> are
larger when areas <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are closer to each other. In a linear
model, the predictor term <span class="math inline">\(\eta\)</span> is
given by <span class="math inline">\(\eta = X \beta\)</span> with design
matrix <span class="math inline">\(X\)</span> and regression
coefficients <span class="math inline">\(\beta\)</span>. However, since
the above equation holds for arbitrary <span class="math inline">\(\eta\)</span>, these results are not restricted to
linear models.</p>
<p>If we have <span class="math inline">\(\epsilon \sim {\mathrm N}(0,
\,\sigma^2 I)\)</span>, it follows that <span class="math display">\[
(I - \rho W)y \sim {\mathrm N}(\eta, \sigma^2 I),
\]</span> which corresponds to the following log PDF coded in
<strong>Stan</strong>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="sc">/</span><span class="er">**</span> </span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a> <span class="er">*</span> Normal log<span class="sc">-</span>pdf <span class="cf">for</span> spatially lagged responses</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a> <span class="sc">*</span> </span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a> <span class="er">*</span> <span class="er">@</span>param y Vector of response values.</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a> <span class="sc">*</span> <span class="er">@</span>param mu Mean parameter vector.</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a> <span class="sc">*</span> <span class="er">@</span>param sigma Positive scalar residual standard deviation.</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a> <span class="sc">*</span> <span class="er">@</span>param rho Positive scalar autoregressive parameter.</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a> <span class="sc">*</span> <span class="er">@</span>param W Spatial weight matrix.</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a> <span class="sc">*</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a> <span class="er">*</span> <span class="er">@</span>return A scalar to be added to the log posterior.</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a> <span class="sc">*</span><span class="er">/</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>real <span class="fu">normal_lagsar_lpdf</span>(vector y, vector mu, real sigma, </span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>                        real rho, matrix W) {</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  int N <span class="ot">=</span> <span class="fu">rows</span>(y);</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>  real inv_sigma2 <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">square</span>(sigma);</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  matrix[N, N] W_tilde <span class="ot">=</span> <span class="sc">-</span>rho <span class="sc">*</span> W;</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>  vector[N] half_pred;</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  </span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) W_tilde[n,n] <span class="sc">+</span><span class="er">=</span> <span class="dv">1</span>;</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>  </span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>  half_pred <span class="ot">=</span> W_tilde <span class="sc">*</span> (y <span class="sc">-</span> <span class="fu">mdivide_left</span>(W_tilde, mu));</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>  </span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>  return <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">log_determinant</span>(<span class="fu">crossprod</span>(W_tilde) <span class="sc">*</span> inv_sigma2) <span class="sc">-</span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>         <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">dot_self</span>(half_pred) <span class="sc">*</span> inv_sigma2;</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>}</span></code></pre></div>
<p>For the purpose of computing LOO-CV, it makes sense to rewrite the
SAR model in slightly different form. Conditional on <span class="math inline">\(\rho\)</span>, <span class="math inline">\(\eta\)</span>, and <span class="math inline">\(\sigma\)</span>, if we write</p>
<p><span class="math display">\[\begin{align}
y-(I-\rho W)^{-1}\eta &amp;\sim {\mathrm N}(0, \sigma^2(I-\rho
W)^{-1}(I-\rho W)^{-T}),
\end{align}\]</span> or more compactly, with <span class="math inline">\(\widetilde{W}=(I-\rho W)\)</span>, <span class="math display">\[\begin{align}
y-\widetilde{W}^{-1}\eta &amp;\sim {\mathrm N}(0,
\sigma^2(\widetilde{W}^{T}\widetilde{W})^{-1}),
\end{align}\]</span></p>
<p>then this has the same form as the zero mean Gaussian process from
above. Accordingly, we can compute the leave-one-out predictive
densities with the equations from Sundararajan and Keerthi (2001),
replacing <span class="math inline">\(y\)</span> with <span class="math inline">\((y-\widetilde{W}^{-1}\eta)\)</span> and taking the
covariance matrix <span class="math inline">\(C\)</span> to be <span class="math inline">\(\sigma^2(\widetilde{W}^{T}\widetilde{W})^{-1}\)</span>.</p>
<div class="section level3">
<h3 id="case-study-neighborhood-crime-in-columbus-ohio">Case Study: Neighborhood Crime in Columbus, Ohio<a class="anchor" aria-label="anchor" href="#case-study-neighborhood-crime-in-columbus-ohio"></a>
</h3>
<p>In order to demonstrate how to carry out the computations implied by
these equations, we will first fit a lagged SAR model to data on crime
in 49 different neighborhoods of Columbus, Ohio during the year 1980.
The data was originally described in Aneslin (1988) and ships with the
<strong>spdep</strong> R package.</p>
<p>In addition to the <strong>loo</strong> package, for this analysis we
will use the <strong>brms</strong> interface to Stan to generate a Stan
program and fit the model, and also the <strong>bayesplot</strong> and
<strong>ggplot2</strong> packages for plotting.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mc-stan.org/loo/">"loo"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/paul-buerkner/brms" class="external-link">"brms"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://mc-stan.org/bayesplot/" class="external-link">"bayesplot"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/bayesplot-colors.html" class="external-link">color_scheme_set</a></span><span class="op">(</span><span class="st">"brightblue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/get_theme.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/theme_default.html" class="external-link">theme_default</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">SEED</span> <span class="op">&lt;-</span> <span class="fl">10001</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">SEED</span><span class="op">)</span> <span class="co"># only sets seed for R (seed for Stan set later)</span></span>
<span></span>
<span><span class="co"># loads COL.OLD data frame and COL.nb neighbor list</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">oldcol</span>, package <span class="op">=</span> <span class="st">"spdep"</span><span class="op">)</span> </span></code></pre></div>
<p>The three variables in the data set relevant to this example are:</p>
<ul>
<li>
<code>CRIME</code>: the number of residential burglaries and vehicle
thefts per thousand households in the neighbood</li>
<li>
<code>HOVAL</code>: housing value in units of $1000 USD</li>
<li>
<code>INC</code>: household income in units of $1000 USD</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">COL.OLD</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CRIME"</span>, <span class="st">"HOVAL"</span>, <span class="st">"INC"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code>'data.frame':   49 obs. of  3 variables:
 $ CRIME: num  18.802 32.388 38.426 0.178 15.726 ...
 $ HOVAL: num  44.6 33.2 37.1 75 80.5 ...
 $ INC  : num  21.23 4.48 11.34 8.44 19.53 ...</code></pre>
<p>We will also use the object <code>COL.nb</code>, which is a list
containing information about which neighborhoods border each other. From
this list we will be able to construct the weight matrix to used to help
account for the spatial dependency among the observations.</p>
<div class="section level4">
<h4 id="fit-lagged-sar-model">Fit lagged SAR model<a class="anchor" aria-label="anchor" href="#fit-lagged-sar-model"></a>
</h4>
<p>A model predicting <code>CRIME</code> from <code>INC</code> and
<code>HOVAL</code>, while accounting for the spatial dependency via an
SAR structure, can be specified in <strong>brms</strong> as follows.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">CRIME</span> <span class="op">~</span> <span class="va">INC</span> <span class="op">+</span> <span class="va">HOVAL</span> <span class="op">+</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/sar.html" class="external-link">sar</a></span><span class="op">(</span><span class="va">COL.nb</span>, type <span class="op">=</span> <span class="st">"lag"</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">COL.OLD</span>,</span>
<span>  data2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>COL.nb <span class="op">=</span> <span class="va">COL.nb</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  seed <span class="op">=</span> <span class="va">SEED</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The code above fits the model in <strong>Stan</strong> using a log
PDF equivalent to the <code>normal_lagsar_lpdf</code> function we
defined above. In the summary output below we see that both higher
income and higher housing value predict lower crime rates in the
neighborhood. Moreover, there seems to be substantial spatial
correlation between adjacent neighborhoods, as indicated by the
posterior distribution of the <code>lagsar</code> parameter.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lagsar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="st">"lagsar"</span><span class="op">)</span></span>
<span><span class="va">estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">lagsar</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-distributions.html" class="external-link">mcmc_hist</a></span><span class="op">(</span><span class="va">lagsar</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://mc-stan.org/bayesplot/reference/bayesplot-helpers.html" class="external-link">vline_at</a></span><span class="op">(</span><span class="va">estimates</span>, linetype <span class="op">=</span> <span class="fl">2</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"lagsar: posterior median and 50% central interval"</span><span class="op">)</span></span></code></pre></div>
<p><img src="loo2-non-factorized_files/figure-html/plot-lagsar-1.png" class="r-plt" alt="" width="60%" style="display: block; margin: auto;"></p>
</div>
<div class="section level4">
<h4 id="approximate-loo-cv">Approximate LOO-CV<a class="anchor" aria-label="anchor" href="#approximate-loo-cv"></a>
</h4>
<p>After fitting the model, the next step is to compute the pointwise
log-likelihood values needed for approximate LOO-CV. To do this we will
use the recipe laid out in the previous sections.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posterior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">CRIME</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">posterior</span><span class="op">)</span></span>
<span><span class="va">loglik</span> <span class="op">&lt;-</span> <span class="va">yloo</span> <span class="op">&lt;-</span> <span class="va">sdloo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">S</span>, ncol <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">S</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">posterior</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span></span>
<span>  <span class="va">eta</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="va">b_Intercept</span> <span class="op">+</span> <span class="va">p</span><span class="op">$</span><span class="va">b_INC</span> <span class="op">*</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">INC</span> <span class="op">+</span> <span class="va">p</span><span class="op">$</span><span class="va">b_HOVAL</span> <span class="op">*</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">HOVAL</span></span>
<span>  <span class="va">W_tilde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">-</span> <span class="va">p</span><span class="op">$</span><span class="va">lagsar</span> <span class="op">*</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2mat.html" class="external-link">nb2mat</a></span><span class="op">(</span><span class="va">COL.nb</span><span class="op">)</span></span>
<span>  <span class="va">Cinv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">W_tilde</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">W_tilde</span> <span class="op">/</span> <span class="va">p</span><span class="op">$</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">g</span> <span class="op">&lt;-</span> <span class="va">Cinv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">W_tilde</span>, <span class="va">eta</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">cbar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">Cinv</span><span class="op">)</span></span>
<span>  <span class="va">yloo</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">-</span> <span class="va">g</span> <span class="op">/</span> <span class="va">cbar</span></span>
<span>  <span class="va">sdloo</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">cbar</span><span class="op">)</span></span>
<span>  <span class="va">loglik</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">yloo</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span>, <span class="va">sdloo</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># use loo for psis smoothing</span></span>
<span><span class="va">log_ratios</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">loglik</span></span>
<span><span class="va">psis_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/psis.html">psis</a></span><span class="op">(</span><span class="va">log_ratios</span><span class="op">)</span></span></code></pre></div>
<p>The quality of the PSIS-LOO approximation can be investigated
graphically by plotting the Pareto-k estimate for each observation. The
approximation is robust up to values of <span class="math inline">\(0.7\)</span> (Vehtari et al, 2017, 2024). In the
plot below, we see that the fourth observation is problematic and so may
reduce the accuracy of the LOO-CV approximation.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">psis_result</span>, label_points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="loo2-non-factorized_files/figure-html/plot-1.png" class="r-plt" alt="" width="60%" style="display: block; margin: auto;"></p>
<p>We can also check that the conditional leave-one-out predictive
distribution equations work correctly, for instance, using the last
posterior draw:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yloo_sub</span> <span class="op">&lt;-</span> <span class="va">yloo</span><span class="op">[</span><span class="va">S</span>, <span class="op">]</span></span>
<span><span class="va">sdloo_sub</span> <span class="op">&lt;-</span> <span class="va">sdloo</span><span class="op">[</span><span class="va">S</span>, <span class="op">]</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">y</span>, </span>
<span>  yloo <span class="op">=</span> <span class="va">yloo_sub</span>,</span>
<span>  ymin <span class="op">=</span> <span class="va">yloo_sub</span> <span class="op">-</span> <span class="va">sdloo_sub</span> <span class="op">*</span> <span class="fl">2</span>,</span>
<span>  ymax <span class="op">=</span> <span class="va">yloo_sub</span> <span class="op">+</span> <span class="va">sdloo_sub</span> <span class="op">*</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">y</span>, y <span class="op">=</span> <span class="va">yloo</span>, ymin <span class="op">=</span> <span class="va">ymin</span>, ymax <span class="op">=</span> <span class="va">ymax</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span></span>
<span>    width <span class="op">=</span> <span class="fl">1</span>, </span>
<span>    color <span class="op">=</span> <span class="st">"skyblue3"</span>, </span>
<span>    position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitter.html" class="external-link">position_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"gray30"</span>, size <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="loo2-non-factorized_files/figure-html/checklast-1.png" class="r-plt" alt="" width="60%" style="display: block; margin: auto;"></p>
<p>Finally, we use PSIS-LOO to approximate the expected log predictive
density (ELPD) for new data, which we will validate using exact LOO-CV
in the upcoming section.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">psis_loo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.html">loo</a></span><span class="op">(</span><span class="va">loglik</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>
Computed from 4000 by 49 log-likelihood matrix.

         Estimate   SE
elpd_loo   -186.9 10.9
p_loo         8.1  5.2
looic       373.8 21.8
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume independent draws (r_eff=1).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     48    98.0%   550     
   (0.7, 1]   (bad)       1     2.0%   &lt;NA&gt;    
   (1, Inf)   (very bad)  0     0.0%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<div class="section level4">
<h4 id="exact-loo-cv">Exact LOO-CV<a class="anchor" aria-label="anchor" href="#exact-loo-cv"></a>
</h4>
<p>Exact LOO-CV for the above example is somewhat more involved, as we
need to re-fit the model <span class="math inline">\(N\)</span> times
and each time model the held-out data point as a parameter. First, we
create an empty dummy model that we will update below as we loop over
the observations.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># see help("mi", "brms") for details on the mi() usage</span></span>
<span><span class="va">fit_dummy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">CRIME</span> <span class="op">|</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/mi.html" class="external-link">mi</a></span><span class="op">(</span><span class="op">)</span> <span class="op">~</span> <span class="va">INC</span> <span class="op">+</span> <span class="va">HOVAL</span> <span class="op">+</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/sar.html" class="external-link">sar</a></span><span class="op">(</span><span class="va">COL.nb</span>, type <span class="op">=</span> <span class="st">"lag"</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">COL.OLD</span>,</span>
<span>  data2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>COL.nb <span class="op">=</span> <span class="va">COL.nb</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>Running /opt/R/4.5.2/lib/R/bin/R CMD SHLIB foo.c
using C compiler: ‘gcc (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0’
gcc -std=gnu2x -I"/opt/R/4.5.2/lib/R/include" -DNDEBUG   -I"/home/runner/work/_temp/Library/Rcpp/include/"  -I"/home/runner/work/_temp/Library/RcppEigen/include/"  -I"/home/runner/work/_temp/Library/RcppEigen/include/unsupported"  -I"/home/runner/work/_temp/Library/BH/include" -I"/home/runner/work/_temp/Library/StanHeaders/include/src/"  -I"/home/runner/work/_temp/Library/StanHeaders/include/"  -I"/home/runner/work/_temp/Library/RcppParallel/include/"  -I"/home/runner/work/_temp/Library/rstan/include" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DUSE_STANC3 -DSTRICT_R_HEADERS  -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION  -D_HAS_AUTO_PTR_ETC=0  -include '/home/runner/work/_temp/Library/StanHeaders/include/stan/math/prim/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/usr/local/include    -fpic  -g -O2  -c foo.c -o foo.o
In file included from /home/runner/work/_temp/Library/RcppEigen/include/Eigen/Core:19,
                 from /home/runner/work/_temp/Library/RcppEigen/include/Eigen/Dense:1,
                 from /home/runner/work/_temp/Library/StanHeaders/include/stan/math/prim/fun/Eigen.hpp:22,
                 from &lt;command-line&gt;:
/home/runner/work/_temp/Library/RcppEigen/include/Eigen/src/Core/util/Macros.h:679:10: fatal error: cmath: No such file or directory
  679 | #include &lt;cmath&gt;
      |          ^~~~~~~
compilation terminated.
make: *** [/opt/R/4.5.2/lib/R/etc/Makeconf:202: foo.o] Error 1</code></pre>
<p>Next, we fit the model <span class="math inline">\(N\)</span> times,
each time leaving out a single observation and then computing the log
predictive density for that observation. For obvious reasons, this takes
much longer than the approximation we computed above, but it is
necessary in order to validate the approximate LOO-CV method. Thanks to
the PSIS-LOO approximation, in general doing these slow exact
computations can be avoided.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="va">N</span><span class="op">)</span></span>
<span><span class="va">loglik</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">S</span>, ncol <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dat_mi</span> <span class="op">&lt;-</span> <span class="va">COL.OLD</span></span>
<span>  <span class="va">dat_mi</span><span class="op">$</span><span class="va">CRIME</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>  <span class="va">fit_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">fit_dummy</span>, newdata <span class="op">=</span> <span class="va">dat_mi</span>, </span>
<span>                  <span class="co"># just for vignette</span></span>
<span>                  chains <span class="op">=</span> <span class="fl">1</span>, iter <span class="op">=</span> <span class="va">S</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">posterior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">fit_i</span><span class="op">)</span></span>
<span>  <span class="va">yloo</span> <span class="op">&lt;-</span> <span class="va">sdloo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">S</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">posterior</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span></span>
<span>    <span class="va">y_miss_i</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>    <span class="va">y_miss_i</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="va">Ymi</span></span>
<span>    <span class="va">eta</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="va">b_Intercept</span> <span class="op">+</span> <span class="va">p</span><span class="op">$</span><span class="va">b_INC</span> <span class="op">*</span> <span class="va">fit_i</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">INC</span> <span class="op">+</span> <span class="va">p</span><span class="op">$</span><span class="va">b_HOVAL</span> <span class="op">*</span> <span class="va">fit_i</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">HOVAL</span></span>
<span>    <span class="va">W_tilde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">-</span> <span class="va">p</span><span class="op">$</span><span class="va">lagsar</span> <span class="op">*</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2mat.html" class="external-link">nb2mat</a></span><span class="op">(</span><span class="va">COL.nb</span><span class="op">)</span></span>
<span>    <span class="va">Cinv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">W_tilde</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">W_tilde</span> <span class="op">/</span> <span class="va">p</span><span class="op">$</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span></span>
<span>    <span class="va">g</span> <span class="op">&lt;-</span> <span class="va">Cinv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="op">(</span><span class="va">y_miss_i</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">W_tilde</span>, <span class="va">eta</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">cbar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">Cinv</span><span class="op">)</span>;</span>
<span>    <span class="va">yloo</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y_miss_i</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">g</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span> <span class="va">cbar</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">sdloo</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">cbar</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">loglik</span><span class="op">[</span><span class="va">s</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">yloo</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, <span class="va">sdloo</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">ypred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">yloo</span>, <span class="va">sdloo</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">posterior</span><span class="op">$</span><span class="va">Ymi</span>, <span class="va">ypred</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pp"</span>, <span class="st">"loo"</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">S</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span><span class="op">}</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">res</span><span class="op">)</span></span></code></pre></div>
<p>A first step in the validation of the pointwise predictive density is
to compare the distribution of the implied response values for the
left-out observation to the distribution of the <span class="math inline">\(y_i^{\mathrm{mis}}\)</span> posterior-predictive
values estimated as part of the model. If the pointwise predictive
density is correct, the two distributions should match very closely (up
to sampling error). In the plot below, we overlay these two
distributions for the first four observations and see that they match
very closely (as is the case for all <span class="math inline">\(49\)</span> observations of in this example).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_sub</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[</span><span class="va">res</span><span class="op">$</span><span class="va">obs</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">res_sub</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">y</span>, fill <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="st">"obs"</span>, scales <span class="op">=</span> <span class="st">"fixed"</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="loo2-non-factorized_files/figure-html/yplots-1.png" class="r-plt" alt="" width="95%" style="display: block; margin: auto;"></p>
<p>In the final step, we compute the ELPD based on the exact LOO-CV and
compare it to the approximate PSIS-LOO result computed earlier.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">log_mean_exp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># more stable than log(mean(exp(x)))</span></span>
<span>  <span class="va">max_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">max_x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">max_x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">exact_elpds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">loglik</span>, <span class="fl">2</span>, <span class="va">log_mean_exp</span><span class="op">)</span></span>
<span><span class="va">exact_elpd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">exact_elpds</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">exact_elpd</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] -189</code></pre>
<p>The results of the approximate and exact LOO-CV are similar but not
as close as we would expect if there were no problematic observations.
We can investigate this issue more closely by plotting the approximate
against the exact pointwise ELPD values.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  approx_elpd <span class="op">=</span> <span class="va">psis_loo</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>, <span class="st">"elpd_loo"</span><span class="op">]</span>,</span>
<span>  exact_elpd <span class="op">=</span> <span class="va">exact_elpds</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">approx_elpd</span>, y <span class="op">=</span> <span class="va">exact_elpd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"gray30"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="fl">4</span>, <span class="op">]</span>, size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"red3"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Approximate elpds"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Exact elpds"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">16</span>, <span class="op">-</span><span class="fl">3</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">16</span>, <span class="op">-</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="loo2-non-factorized_files/figure-html/compare-1.png" class="r-plt" alt="" width="60%" style="display: block; margin: auto;"></p>
<p>In the plot above the fourth data point —the observation flagged as
problematic by the PSIS-LOO approximation— is colored in red and is the
clear outlier. Otherwise, the correspondence between the exact and
approximate values is strong. In fact, summing over the pointwise ELPD
values and leaving out the fourth observation yields practically
equivalent results for approximate and exact LOO-CV:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">without_pt_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  approx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">psis_loo</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span><span class="op">-</span><span class="fl">4</span>, <span class="st">"elpd_loo"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  exact <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">exact_elpds</span><span class="op">[</span><span class="op">-</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>  </span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">without_pt_4</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code>approx  exact 
-173.0 -173.1 </code></pre>
<p>From this we can conclude that the difference we found when including
<em>all</em> observations does not indicate a bug in our implementation
of the approximate LOO-CV but rather a violation of its assumptions.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="working-with-stan-directly">Working with Stan directly<a class="anchor" aria-label="anchor" href="#working-with-stan-directly"></a>
</h2>
<p>So far, we have specified the models in brms and only used Stan
implicitely behind the scenes. This allowed us to focus on the primary
purpose of validating approximate LOO-CV for non-factorized models.
However, we would also like to show how everything can be set up in Stan
directly. The Stan code brms generates is human readable and so we can
use it to learn some of the essential aspects of Stan and the particular
model we are implementing. The Stan program below is a slightly modified
version of the code extracted via <code>stancode(fit_dummy)</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="sc">/</span><span class="er">/</span> generated with brms <span class="dv">2</span>.<span class="fl">2.0</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>functions {</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="sc">/</span><span class="er">**</span> </span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a> <span class="er">*</span> Normal log<span class="sc">-</span>pdf <span class="cf">for</span> spatially lagged responses</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a> <span class="sc">*</span> </span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a> <span class="er">*</span> <span class="er">@</span>param y Vector of response values.</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a> <span class="sc">*</span> <span class="er">@</span>param mu Mean parameter vector.</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a> <span class="sc">*</span> <span class="er">@</span>param sigma Positive scalar residual standard deviation.</span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a> <span class="sc">*</span> <span class="er">@</span>param rho Positive scalar autoregressive parameter.</span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a> <span class="sc">*</span> <span class="er">@</span>param W Spatial weight matrix.</span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a> <span class="sc">*</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a> <span class="er">*</span> <span class="er">@</span>return A scalar to be added to the log posterior.</span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a> <span class="sc">*</span><span class="er">/</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>  real <span class="fu">normal_lagsar_lpdf</span>(vector y, vector mu, real sigma,</span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a>                          real rho, matrix W) {</span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>    int N <span class="ot">=</span> <span class="fu">rows</span>(y);</span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a>    real inv_sigma2 <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">square</span>(sigma);</span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a>    matrix[N, N] W_tilde <span class="ot">=</span> <span class="sc">-</span>rho <span class="sc">*</span> W;</span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a>    vector[N] half_pred;</span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a>    <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) W_tilde[n, n] <span class="sc">+</span><span class="er">=</span> <span class="dv">1</span>;</span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a>    half_pred <span class="ot">=</span> W_tilde <span class="sc">*</span> (y <span class="sc">-</span> <span class="fu">mdivide_left</span>(W_tilde, mu));</span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a>    return <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">log_determinant</span>(<span class="fu">crossprod</span>(W_tilde) <span class="sc">*</span> inv_sigma2) <span class="sc">-</span></span>
<span id="cb21-23"><a href="#cb21-23" tabindex="-1"></a>           <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">dot_self</span>(half_pred) <span class="sc">*</span> inv_sigma2;</span>
<span id="cb21-24"><a href="#cb21-24" tabindex="-1"></a>  }</span>
<span id="cb21-25"><a href="#cb21-25" tabindex="-1"></a>}</span>
<span id="cb21-26"><a href="#cb21-26" tabindex="-1"></a>data {</span>
<span id="cb21-27"><a href="#cb21-27" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> N;  <span class="sc">/</span><span class="er">/</span> total number of observations</span>
<span id="cb21-28"><a href="#cb21-28" tabindex="-1"></a>  vector[N] Y;  <span class="sc">/</span><span class="er">/</span> response variable</span>
<span id="cb21-29"><a href="#cb21-29" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> Nmi;  <span class="sc">/</span><span class="er">/</span> number of missings</span>
<span id="cb21-30"><a href="#cb21-30" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> Jmi[Nmi];  <span class="sc">/</span><span class="er">/</span> positions of missings</span>
<span id="cb21-31"><a href="#cb21-31" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> K;  <span class="sc">/</span><span class="er">/</span> number of population<span class="sc">-</span>level effects</span>
<span id="cb21-32"><a href="#cb21-32" tabindex="-1"></a>  matrix[N, K] X;  <span class="sc">/</span><span class="er">/</span> population<span class="sc">-</span>level design matrix</span>
<span id="cb21-33"><a href="#cb21-33" tabindex="-1"></a>  matrix[N, N] W;  <span class="sc">/</span><span class="er">/</span> spatial weight matrix</span>
<span id="cb21-34"><a href="#cb21-34" tabindex="-1"></a>  int prior_only;  <span class="sc">/</span><span class="er">/</span> should the likelihood be ignored?</span>
<span id="cb21-35"><a href="#cb21-35" tabindex="-1"></a>}</span>
<span id="cb21-36"><a href="#cb21-36" tabindex="-1"></a>transformed data {</span>
<span id="cb21-37"><a href="#cb21-37" tabindex="-1"></a>  int Kc <span class="ot">=</span> K <span class="sc">-</span> <span class="dv">1</span>;</span>
<span id="cb21-38"><a href="#cb21-38" tabindex="-1"></a>  matrix[N, K <span class="sc">-</span> <span class="dv">1</span>] Xc;  <span class="sc">/</span><span class="er">/</span> centered version of X</span>
<span id="cb21-39"><a href="#cb21-39" tabindex="-1"></a>  vector[K <span class="sc">-</span> <span class="dv">1</span>] means_X;  <span class="sc">/</span><span class="er">/</span> column means of X before centering</span>
<span id="cb21-40"><a href="#cb21-40" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>K) {</span>
<span id="cb21-41"><a href="#cb21-41" tabindex="-1"></a>    means_X[i <span class="sc">-</span> <span class="dv">1</span>] <span class="ot">=</span> <span class="fu">mean</span>(X[, i]);</span>
<span id="cb21-42"><a href="#cb21-42" tabindex="-1"></a>    Xc[, i <span class="sc">-</span> <span class="dv">1</span>] <span class="ot">=</span> X[, i] <span class="sc">-</span> means_X[i <span class="sc">-</span> <span class="dv">1</span>];</span>
<span id="cb21-43"><a href="#cb21-43" tabindex="-1"></a>  }</span>
<span id="cb21-44"><a href="#cb21-44" tabindex="-1"></a>}</span>
<span id="cb21-45"><a href="#cb21-45" tabindex="-1"></a>parameters {</span>
<span id="cb21-46"><a href="#cb21-46" tabindex="-1"></a>  vector[Nmi] Ymi;  <span class="sc">/</span><span class="er">/</span> estimated missings</span>
<span id="cb21-47"><a href="#cb21-47" tabindex="-1"></a>  vector[Kc] b;  <span class="sc">/</span><span class="er">/</span> population<span class="sc">-</span>level effects</span>
<span id="cb21-48"><a href="#cb21-48" tabindex="-1"></a>  real temp_Intercept;  <span class="sc">/</span><span class="er">/</span> temporary intercept</span>
<span id="cb21-49"><a href="#cb21-49" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> sigma;  <span class="sc">/</span><span class="er">/</span> residual SD</span>
<span id="cb21-50"><a href="#cb21-50" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span>,upper<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> lagsar;  <span class="sc">/</span><span class="er">/</span> SAR parameter</span>
<span id="cb21-51"><a href="#cb21-51" tabindex="-1"></a>}</span>
<span id="cb21-52"><a href="#cb21-52" tabindex="-1"></a>transformed parameters {</span>
<span id="cb21-53"><a href="#cb21-53" tabindex="-1"></a>}</span>
<span id="cb21-54"><a href="#cb21-54" tabindex="-1"></a>model {</span>
<span id="cb21-55"><a href="#cb21-55" tabindex="-1"></a>  vector[N] Yl <span class="ot">=</span> Y;</span>
<span id="cb21-56"><a href="#cb21-56" tabindex="-1"></a>  vector[N] mu <span class="ot">=</span> Xc <span class="sc">*</span> b <span class="sc">+</span> temp_Intercept;</span>
<span id="cb21-57"><a href="#cb21-57" tabindex="-1"></a>  Yl[Jmi] <span class="ot">=</span> Ymi;</span>
<span id="cb21-58"><a href="#cb21-58" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span> priors including all constants</span>
<span id="cb21-59"><a href="#cb21-59" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> <span class="fu">student_t_lpdf</span>(temp_Intercept <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">34</span>, <span class="dv">17</span>);</span>
<span id="cb21-60"><a href="#cb21-60" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> <span class="fu">student_t_lpdf</span>(sigma <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">17</span>)</span>
<span id="cb21-61"><a href="#cb21-61" tabindex="-1"></a>    <span class="sc">-</span> <span class="dv">1</span> <span class="sc">*</span> <span class="fu">student_t_lccdf</span>(<span class="dv">0</span> <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">17</span>);</span>
<span id="cb21-62"><a href="#cb21-62" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span> likelihood including all constants</span>
<span id="cb21-63"><a href="#cb21-63" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>prior_only) {</span>
<span id="cb21-64"><a href="#cb21-64" tabindex="-1"></a>    target <span class="sc">+</span><span class="er">=</span> <span class="fu">normal_lagsar_lpdf</span>(Yl <span class="sc">|</span> mu, sigma, lagsar, W);</span>
<span id="cb21-65"><a href="#cb21-65" tabindex="-1"></a>  }</span>
<span id="cb21-66"><a href="#cb21-66" tabindex="-1"></a>}</span>
<span id="cb21-67"><a href="#cb21-67" tabindex="-1"></a>generated quantities {</span>
<span id="cb21-68"><a href="#cb21-68" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span> actual population<span class="sc">-</span>level intercept</span>
<span id="cb21-69"><a href="#cb21-69" tabindex="-1"></a>  real b_Intercept <span class="ot">=</span> temp_Intercept <span class="sc">-</span> <span class="fu">dot_product</span>(means_X, b);</span>
<span id="cb21-70"><a href="#cb21-70" tabindex="-1"></a>}</span></code></pre></div>
<p>Here we want to focus on two aspects of the Stan code. First, because
there is no built-in function in Stan that calculates the log-likelihood
for the lag-SAR model, we define a new <code>normal_lagsar_lpdf</code>
function in the <code>functions</code> block of the Stan program. This
is the same function we showed earlier in the vignette and it can be
used to compute the log-likelihood in an efficient and numerically
stable way. The <code>_lpdf</code> suffix used in the function name
informs Stan that this is a log probability density function.</p>
<p>Second, this Stan program nicely illustrates how to set up missing
value imputation. Instead of just computing the log-likelihood for the
observed responses <code>Y</code>, we define a new variable
<code>Yl</code> which is equal to <code>Y</code> if the reponse is
observed and equal to <code>Ymi</code> if the response is missing. The
latter is in turn defined as a parameter and thus estimated along with
all other paramters of the model. More details about missing value
imputation in Stan can be found in the <em>Missing Data &amp; Partially
Known Parameters</em> section of the <a href="https://mc-stan.org/users/documentation/index.html" class="external-link">Stan
manual</a>.</p>
<p>The Stan code extracted from brms is not only helpful when learning
Stan, but can also drastically speed up the specification of models that
are not support by brms. If brms can fit a model similar but not
identical to the desired model, we can let brms generate the Stan
program for the similar model and then mold it into the program that
implements the model we actually want to fit. Rather than calling
<code><a href="https://paulbuerkner.com/brms/reference/stancode.html" class="external-link">stancode()</a></code>, which requires an existing fitted model object,
we recommend using <code><a href="https://paulbuerkner.com/brms/reference/stancode.html" class="external-link">make_stancode()</a></code> and specifying the
<code>save_model</code> argument to write the Stan program to a file.
The corresponding data can be prepared with <code><a href="https://paulbuerkner.com/brms/reference/standata.html" class="external-link">make_standata()</a></code>
and then manually amended if needed. Once the code and data have been
edited, they can be passed to RStan’s <code><a href="https://mc-stan.org/rstan/reference/stan.html" class="external-link">stan()</a></code> function via
the <code>file</code> and <code>data</code> arguments.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In summary, we have shown how to set up and validate approximate and
exact LOO-CV for non-factorized multivariate normal models using Stan
with the <strong>brms</strong> and <strong>loo</strong> packages.
Although we focused on the particular example of a spatial SAR model,
the presented recipe applies more generally to models that can be
expressed in terms of a multivariate normal likelihood.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Anselin L. (1988). <em>Spatial econometrics: methods and models</em>.
Dordrecht: Kluwer Academic.</p>
<p>Bürkner P. C., Gabry J., &amp; Vehtari A. (2020). Efficient
leave-one-out cross-validation for Bayesian non-factorized normal and
Student-t models. <em>Computational Statistics</em>,
:10.1007/s00180-020-01045-4. <a href="https://arxiv.org/abs/1810.10559" class="external-link">ArXiv preprint</a>.</p>
<p>Sundararajan S. &amp; Keerthi S. S. (2001). Predictive approaches for
choosing hyperparameters in Gaussian processes. <em>Neural
Computation</em>, 13(5), 1103–1118.</p>
<p>Vehtari A., Mononen T., Tolvanen V., Sivula T., &amp; Winther O.
(2016). Bayesian leave-one-out cross-validation approximations for
Gaussian latent variable models. <em>Journal of Machine Learning
Research</em>, 17(103), 1–38. <a href="https://jmlr.org/papers/v17/14-540.html" class="external-link">Online</a>.</p>
<p>Vehtari A., Gelman A., &amp; Gabry J. (2017). Practical Bayesian
model evaluation using leave-one-out cross-validation and WAIC.
<em>Statistics and Computing</em>, 27(5), 1413–1432.
:10.1007/s11222-016-9696-4. <a href="https://link.springer.com/article/10.1007/s11222-016-9696-4" class="external-link">Online</a>.
<a href="https://arxiv.org/abs/1507.04544" class="external-link">arXiv preprint
arXiv:1507.04544</a>.</p>
<p>Vehtari, A., Simpson, D., Gelman, A., Yao, Y., and Gabry, J. (2024).
Pareto smoothed importance sampling. <em>Journal of Machine Learning
Research</em>, 25(72):1-58. <a href="https://jmlr.org/papers/v25/19-556.html" class="external-link">PDF</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Aki Vehtari, Jonah Gabry, Måns Magnusson, Yuling Yao, Paul-Christian Bürkner, Topi Paananen, Andrew Gelman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
