<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- upstream: inst/BS5/templates/head.html; pkgdown-version: 2.1.3, fe04924 --><!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 --><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Efficient approximate leave-one-out cross-validation (LOO) — loo • loo</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_3-0.4.10/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- Font Awesome 7.0.1 for Bluesky icon --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" referrerpolicy="no-referrer"><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Efficient approximate leave-one-out cross-validation (LOO) — loo"><meta name="description" content="The loo() methods for arrays, matrices, and functions compute PSIS-LOO
CV, efficient approximate leave-one-out (LOO) cross-validation for Bayesian
models using Pareto smoothed importance sampling (PSIS). This is
an implementation of the methods described in Vehtari, Gelman, and Gabry
(2017) and Vehtari, Simpson, Gelman, Yao, and Gabry (2024).
The loo_i() function enables testing log-likelihood
functions for use with the loo.function() method."><meta property="og:description" content="The loo() methods for arrays, matrices, and functions compute PSIS-LOO
CV, efficient approximate leave-one-out (LOO) cross-validation for Bayesian
models using Pareto smoothed importance sampling (PSIS). This is
an implementation of the methods described in Vehtari, Gelman, and Gabry
(2017) and Vehtari, Simpson, Gelman, Yao, and Gabry (2024).
The loo_i() function enables testing log-likelihood
functions for use with the loo.function() method."><meta property="og:image" content="https://mc-stan.org/loo/logo.svg"><meta name="robots" content="noindex"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <!-- upstream: inst/BS5/templates/navbar.html; pkgdown-version: 2.1.3, fe04924 -->
<!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 -->
<nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">


    <a class="navbar-brand me-2" href="../index.html">
      <!-- Add Stan logo -->
      <picture><source type="image/svg+xml" srcset="../logo.svg"><img src="../logo.png" class="stan-logo" alt="Stan blue hex logo"></source></picture>
      loo
    </a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.8.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Go to homepage"><span class="fa fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-other-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Other Packages</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-other-packages"><li><a class="external-link dropdown-item" href="https://mc-stan.org/rstan">rstan</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/cmdstanr">cmdstanr</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstanarm">rstanarm</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/bayesplot">bayesplot</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/shinystan">shinystan</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/projpred">projpred</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstantools">rstantools</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/posterior">posterior</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mc-stan.org/about/">About Stan</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/did:plc:qznndgdnkem2yryu7ipqbpv7" aria-label="Visit our Bluesky profile"><span class="fa fa-brands fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://discourse.mc-stan.org/" aria-label="Visit our forums"><span class="fa fa-users"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stan-dev/loo/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Efficient approximate leave-one-out cross-validation (LOO)</h1>
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/loo/blob/master/R/loo.R" class="external-link"><code>R/loo.R</code></a></small>
      <div class="d-none name"><code>loo.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>The <code>loo()</code> methods for arrays, matrices, and functions compute PSIS-LOO
CV, efficient approximate leave-one-out (LOO) cross-validation for Bayesian
models using Pareto smoothed importance sampling (<a href="psis.html">PSIS</a>). This is
an implementation of the methods described in Vehtari, Gelman, and Gabry
(2017) and Vehtari, Simpson, Gelman, Yao, and Gabry (2024).</p>
<p>The <code>loo_i()</code> function enables testing log-likelihood
functions for use with the <code>loo.function()</code> method.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">loo</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'array'</span></span>
<span><span class="fu">loo</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  r_eff <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  save_psis <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"mc.cores"</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  is_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"psis"</span>, <span class="st">"tis"</span>, <span class="st">"sis"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'matrix'</span></span>
<span><span class="fu">loo</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  r_eff <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  save_psis <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"mc.cores"</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  is_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"psis"</span>, <span class="st">"tis"</span>, <span class="st">"sis"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class '`function`'</span></span>
<span><span class="fu">loo</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  draws <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  r_eff <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  save_psis <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"mc.cores"</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  is_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"psis"</span>, <span class="st">"tis"</span>, <span class="st">"sis"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">loo_i</span><span class="op">(</span><span class="va">i</span>, <span class="va">llfun</span>, <span class="va">...</span>, data <span class="op">=</span> <span class="cn">NULL</span>, draws <span class="op">=</span> <span class="cn">NULL</span>, r_eff <span class="op">=</span> <span class="fl">1</span>, is_method <span class="op">=</span> <span class="st">"psis"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">is.loo</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">is.psis_loo</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>A log-likelihood array, matrix, or function. The <strong>Methods (by class)</strong>
section, below, has detailed descriptions of how to specify the inputs for
each method.</p></dd>


<dt id="arg-r-eff">r_eff<a class="anchor" aria-label="anchor" href="#arg-r-eff"></a></dt>
<dd><p>Vector of relative effective sample size estimates for the
likelihood (<code>exp(log_lik)</code>) of each observation. This is related to
the relative efficiency of estimating the normalizing term in
self-normalized importance sampling when using posterior draws obtained
with MCMC. If MCMC draws are used and <code>r_eff</code> is not provided then
the reported PSIS effective sample sizes and Monte Carlo error estimates
can be over-optimistic. If the posterior draws are (near) independent then
<code>r_eff=1</code> can be used. <code>r_eff</code> has to be a scalar (same value is used
for all observations) or a vector with length equal to the number of
observations. The default value is 1. See the <code><a href="relative_eff.html">relative_eff()</a></code> helper
functions for help computing <code>r_eff</code>.</p></dd>


<dt id="arg-save-psis">save_psis<a class="anchor" aria-label="anchor" href="#arg-save-psis"></a></dt>
<dd><p>Should the <code>psis</code> object created internally by <code>loo()</code> be
saved in the returned object? The <code>loo()</code> function calls <code><a href="psis.html">psis()</a></code>
internally but by default discards the (potentially large) <code>psis</code> object
after using it to compute the LOO-CV summaries. Setting <code>save_psis=TRUE</code>
will add a <code>psis_object</code> component to the list returned by <code>loo</code>.
This is useful if you plan to use the <code><a href="E_loo.html">E_loo()</a></code> function to compute
weighted expectations after running <code>loo</code>. Several functions in the
<span class="pkg">bayesplot</span> package also accept <code>psis</code> objects.</p></dd>


<dt id="arg-cores">cores<a class="anchor" aria-label="anchor" href="#arg-cores"></a></dt>
<dd><p>The number of cores to use for parallelization. This defaults to
the option <code>mc.cores</code> which can be set for an entire R session by
<code>options(mc.cores = NUMBER)</code>. The old option <code>loo.cores</code> is now
deprecated but will be given precedence over <code>mc.cores</code> until
<code>loo.cores</code> is removed in a future release. <strong>As of version
2.0.0 the default is now 1 core if <code>mc.cores</code> is not set</strong>, but we
recommend using as many (or close to as many) cores as possible.</p><ul><li><p>Note for Windows 10 users: it is <strong>strongly</strong>
<a href="https://github.com/stan-dev/loo/issues/94" class="external-link">recommended</a> to avoid using
the <code>.Rprofile</code> file to set <code>mc.cores</code> (using the <code>cores</code> argument or
setting <code>mc.cores</code> interactively or in a script is fine).</p></li>
</ul></dd>


<dt id="arg-is-method">is_method<a class="anchor" aria-label="anchor" href="#arg-is-method"></a></dt>
<dd><p>The importance sampling method to use. The following methods
are implemented:</p><ul><li><p><code><a href="psis.html">"psis"</a></code>: Pareto-Smoothed Importance Sampling (PSIS). Default method.</p></li>
<li><p><code><a href="tis.html">"tis"</a></code>: Truncated Importance Sampling (TIS) with truncation at
<code>sqrt(S)</code>, where <code>S</code> is the number of posterior draws.</p></li>
<li><p><code><a href="sis.html">"sis"</a></code>: Standard Importance Sampling (SIS).</p></li>
</ul></dd>


<dt id="arg-data-draws-">data, draws, ...<a class="anchor" aria-label="anchor" href="#arg-data-draws-"></a></dt>
<dd><p>For the <code>loo.function()</code> method and the <code>loo_i()</code>
function, these are the data, posterior draws, and other arguments to pass
to the log-likelihood function. See the <strong>Methods (by class)</strong> section
below for details on how to specify these arguments.</p></dd>


<dt id="arg-i">i<a class="anchor" aria-label="anchor" href="#arg-i"></a></dt>
<dd><p>For <code>loo_i()</code>, an integer in <code>1:N</code>.</p></dd>


<dt id="arg-llfun">llfun<a class="anchor" aria-label="anchor" href="#arg-llfun"></a></dt>
<dd><p>For <code>loo_i()</code>, the same as <code>x</code> for the
<code>loo.function()</code> method. A log-likelihood function as described in the
<strong>Methods (by class)</strong> section.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>The <code>loo()</code> methods return a named list with class
<code>c("psis_loo", "loo")</code> and components:</p><dl><dt><code>estimates</code></dt>
<dd><p>A matrix with two columns (<code>Estimate</code>, <code>SE</code>) and three rows (<code>elpd_loo</code>,
<code>p_loo</code>, <code>looic</code>). This contains point estimates and standard errors of the
expected log pointwise predictive density (<code><a href="loo-glossary.html">elpd_loo</a></code>), the
effective number of parameters (<code><a href="loo-glossary.html">p_loo</a></code>) and the LOO
information criterion <code>looic</code> (which is just <code>-2 * elpd_loo</code>, i.e.,
converted to deviance scale).</p></dd>


<dt><code>pointwise</code></dt>
<dd><p>A matrix with five columns (and number of rows equal to the number of
observations) containing the pointwise contributions of the measures
(<code>elpd_loo</code>, <code>mcse_elpd_loo</code>, <code>p_loo</code>, <code>looic</code>, <code>influence_pareto_k</code>).
in addition to the three measures in <code>estimates</code>, we also report
pointwise values of the Monte Carlo standard error of <code><a href="loo-glossary.html">elpd_loo</a></code>
(<code><a href="loo-glossary.html">mcse_elpd_loo</a></code>), and statistics describing the influence of
each observation on the posterior distribution (<code>influence_pareto_k</code>).
These are the estimates of the shape parameter \(k\) of the
generalized Pareto fit to the importance ratios for each leave-one-out
distribution (see the <a href="pareto-k-diagnostic.html">pareto-k-diagnostic</a> page for details).</p></dd>


<dt><code>diagnostics</code></dt>
<dd><p>A named list containing two vectors:</p><ul><li><p><code>pareto_k</code>: Importance sampling reliability diagnostics. By default,
these are equal to the <code>influence_pareto_k</code> in <code>pointwise</code>.
Some algorithms can improve importance sampling reliability and
modify these diagnostics. See the <a href="pareto-k-diagnostic.html">pareto-k-diagnostic</a> page for details.</p></li>
<li><p><code>n_eff</code>: PSIS effective sample size estimates.</p></li>
</ul></dd>


<dt><code>psis_object</code></dt>
<dd><p>This component will be <code>NULL</code> unless the <code>save_psis</code> argument is set to
<code>TRUE</code> when calling <code>loo()</code>. In that case <code>psis_object</code> will be the object
of class <code>"psis"</code> that is created when the <code>loo()</code> function calls <code><a href="psis.html">psis()</a></code>
internally to do the PSIS procedure.</p></dd>


</dl><p>The <code>loo_i()</code> function returns a named list with components
<code>pointwise</code> and <code>diagnostics</code>. These components have the same
structure as the <code>pointwise</code> and <code>diagnostics</code> components of the
object returned by <code>loo()</code> except they contain results for only a single
observation.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The <code>loo()</code> function is an S3 generic and methods are provided for
3-D pointwise log-likelihood arrays, pointwise log-likelihood matrices, and
log-likelihood functions. The array and matrix methods are the most
convenient, but for models fit to very large datasets the <code>loo.function()</code>
method is more memory efficient and may be preferable.</p>
    </div>
    <div class="section level2">
    <h2 id="methods-by-class-">Methods (by class)<a class="anchor" aria-label="anchor" href="#methods-by-class-"></a></h2>

<ul><li><p><code>loo(array)</code>: An \(I\) by \(C\) by \(N\) array, where \(I\)
is the number of MCMC iterations per chain, \(C\) is the number of
chains, and \(N\) is the number of data points.</p></li>
<li><p><code>loo(matrix)</code>: An \(S\) by \(N\) matrix, where \(S\) is the size
of the posterior sample (with all chains merged) and \(N\) is the number
of data points.</p></li>
<li><p><code>loo(`function`)</code>: A function <code>f()</code> that takes arguments <code>data_i</code> and <code>draws</code> and returns a
vector containing the log-likelihood for a single observation <code>i</code> evaluated
at each posterior draw. The function should be written such that, for each
observation <code>i</code> in <code>1:N</code>, evaluating</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">f</span>(<span class="at">data_i =</span> data[i,, <span class="at">drop=</span><span class="cn">FALSE</span>], <span class="at">draws =</span> draws)</span></code></pre><p></p></div>
<p>results in a vector of length <code>S</code> (size of posterior sample). The
log-likelihood function can also have additional arguments but <code>data_i</code> and
<code>draws</code> are required.</p>
<p>If using the function method then the arguments <code>data</code> and <code>draws</code> must also
be specified in the call to <code>loo()</code>:</p><ul><li><p><code>data</code>: A data frame or matrix containing the data (e.g.
observed outcome and predictors) needed to compute the pointwise
log-likelihood. For each observation <code>i</code>, the <code>i</code>th row of
<code>data</code> will be passed to the <code>data_i</code> argument of the
log-likelihood function.</p></li>
<li><p><code>draws</code>: An object containing the posterior draws for any
parameters needed to compute the pointwise log-likelihood. Unlike
<code>data</code>, which is indexed by observation, for each observation the
entire object <code>draws</code> will be passed to the <code>draws</code> argument of
the log-likelihood function.</p></li>
<li><p>The <code>...</code> can be used if your log-likelihood function takes additional
arguments. These arguments are used like the <code>draws</code> argument in that they
are recycled for each observation.</p></li>
</ul></li>
</ul></div>
    <div class="section level2">
    <h2 id="defining-loo-methods-in-a-package">Defining <code>loo()</code> methods in a package<a class="anchor" aria-label="anchor" href="#defining-loo-methods-in-a-package"></a></h2>
    <p>Package developers can define
<code>loo()</code> methods for fitted models objects. See the example <code>loo.stanfit()</code>
method in the <strong>Examples</strong> section below for an example of defining a
method that calls <code>loo.array()</code>. The <code>loo.stanreg()</code> method in the
<strong>rstanarm</strong> package is an example of defining a method that calls
<code>loo.function()</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical Bayesian model
evaluation using leave-one-out cross-validation and WAIC.
<em>Statistics and Computing</em>. 27(5), 1413–1432. doi:10.1007/s11222-016-9696-4
(<a href="https://link.springer.com/article/10.1007/s11222-016-9696-4" class="external-link">journal version</a>,
<a href="https://arxiv.org/abs/1507.04544" class="external-link">preprint arXiv:1507.04544</a>).</p>
<p>Vehtari, A., Simpson, D., Gelman, A., Yao, Y., and Gabry, J. (2024).
Pareto smoothed importance sampling. <em>Journal of Machine Learning Research</em>,
25(72):1-58.
<a href="https://jmlr.org/papers/v25/19-556.html" class="external-link">PDF</a></p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index">
<ul><li><p>The <strong>loo</strong> package <a href="https://mc-stan.org/loo/articles/index.html">vignettes</a>
for demonstrations.</p></li>
<li><p>The <a href="https://mc-stan.org/loo/articles/online-only/faq.html">FAQ page</a> on
the <strong>loo</strong> website for answers to frequently asked questions.</p></li>
<li><p><code><a href="psis.html">psis()</a></code> for the underlying Pareto Smoothed Importance Sampling (PSIS)
procedure used in the LOO-CV approximation.</p></li>
<li><p><a href="pareto-k-diagnostic.html">pareto-k-diagnostic</a> for convenience functions for looking at diagnostics.</p></li>
<li><p><code><a href="loo_compare.html">loo_compare()</a></code> for model comparison.</p></li>
</ul></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">### Array and matrix methods (using example objects included with loo package)</span></span></span>
<span class="r-in"><span><span class="co"># Array method</span></span></span>
<span class="r-in"><span><span class="va">LLarr</span> <span class="op">&lt;-</span> <span class="fu"><a href="example_loglik_array.html">example_loglik_array</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">rel_n_eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="relative_eff.html">relative_eff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">LLarr</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">loo</span><span class="op">(</span><span class="va">LLarr</span>, r_eff <span class="op">=</span> <span class="va">rel_n_eff</span>, cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Computed from 1000 by 32 log-likelihood matrix.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Estimate  SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> elpd_loo    -83.6 4.3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> p_loo         3.3 1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> looic       167.2 8.6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> MCSE of elpd_loo is 0.1.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> MCSE and ESS estimates assume MCMC draws (r_eff in [0.6, 1.0]).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> All Pareto k estimates are good (k &lt; 0.67).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> See help('pareto-k-diagnostic') for details.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Matrix method</span></span></span>
<span class="r-in"><span><span class="va">LLmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="example_loglik_array.html">example_loglik_matrix</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">rel_n_eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="relative_eff.html">relative_eff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">LLmat</span><span class="op">)</span>, chain_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each <span class="op">=</span> <span class="fl">500</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">loo</span><span class="op">(</span><span class="va">LLmat</span>, r_eff <span class="op">=</span> <span class="va">rel_n_eff</span>, cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Computed from 1000 by 32 log-likelihood matrix.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Estimate  SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> elpd_loo    -83.6 4.3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> p_loo         3.3 1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> looic       167.2 8.6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> MCSE of elpd_loo is 0.1.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> MCSE and ESS estimates assume MCMC draws (r_eff in [0.6, 1.0]).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> All Pareto k estimates are good (k &lt; 0.67).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> See help('pareto-k-diagnostic') for details.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Using log-likelihood function instead of array or matrix</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">124</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate data and draw from posterior</span></span></span>
<span class="r-in"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">50</span>; <span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">10</span>; <span class="va">S</span> <span class="op">&lt;-</span> <span class="fl">100</span>; <span class="va">a0</span> <span class="op">&lt;-</span> <span class="fl">3</span>; <span class="va">b0</span> <span class="op">&lt;-</span> <span class="fl">2</span></span></span>
<span class="r-in"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">a0</span>, <span class="va">b0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size <span class="op">=</span> <span class="va">K</span>, prob <span class="op">=</span> <span class="va">p</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="va">a0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>; <span class="va">b</span> <span class="op">&lt;-</span> <span class="va">b0</span> <span class="op">+</span> <span class="va">N</span> <span class="op">*</span> <span class="va">K</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fake_posterior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">a</span>, <span class="va">b</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">fake_posterior</span><span class="op">)</span> <span class="co"># S x 1</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 100   1</span>
<span class="r-in"><span><span class="va">fake_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">y</span>,<span class="va">K</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">fake_data</span><span class="op">)</span> <span class="co"># N x 2</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 50  2</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">llfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_i</span>, <span class="va">draws</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="co"># each time called internally within loo the arguments will be equal to:</span></span></span>
<span class="r-in"><span>  <span class="co"># data_i: ith row of fake_data (fake_data[i,, drop=FALSE])</span></span></span>
<span class="r-in"><span>  <span class="co"># draws: entire fake_posterior matrix</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="va">data_i</span><span class="op">$</span><span class="va">y</span>, size <span class="op">=</span> <span class="va">data_i</span><span class="op">$</span><span class="va">K</span>, prob <span class="op">=</span> <span class="va">draws</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Use the loo_i function to check that llfun works on a single observation</span></span></span>
<span class="r-in"><span><span class="co"># before running on all obs. For example, using the 3rd obs in the data:</span></span></span>
<span class="r-in"><span><span class="va">loo_3</span> <span class="op">&lt;-</span> <span class="fu">loo_i</span><span class="op">(</span>i <span class="op">=</span> <span class="fl">3</span>, llfun <span class="op">=</span> <span class="va">llfun</span>, data <span class="op">=</span> <span class="va">fake_data</span>, draws <span class="op">=</span> <span class="va">fake_posterior</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_3</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>, <span class="st">"elpd_loo"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  elpd_loo </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> -1.267103 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Use loo.function method (default r_eff=1 is used as this posterior not obtained via MCMC)</span></span></span>
<span class="r-in"><span><span class="va">loo_with_fn</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="op">(</span><span class="va">llfun</span>, draws <span class="op">=</span> <span class="va">fake_posterior</span>, data <span class="op">=</span> <span class="va">fake_data</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># If we look at the elpd_loo contribution from the 3rd obs it should be the</span></span></span>
<span class="r-in"><span><span class="co"># same as what we got above with the loo_i function and i=3:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_with_fn</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span><span class="fl">3</span>, <span class="st">"elpd_loo"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  elpd_loo </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> -1.267103 </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_3</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>, <span class="st">"elpd_loo"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  elpd_loo </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> -1.267103 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Check that the loo.matrix method gives same answer as loo.function method</span></span></span>
<span class="r-in"><span><span class="va">log_lik_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu">llfun</span><span class="op">(</span>data_i <span class="op">=</span> <span class="va">fake_data</span><span class="op">[</span><span class="va">i</span>,, drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>, draws <span class="op">=</span> <span class="va">fake_posterior</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">loo_with_mat</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="op">(</span><span class="va">log_lik_matrix</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">loo_with_mat</span><span class="op">$</span><span class="va">estimates</span>, <span class="va">loo_with_fn</span><span class="op">$</span><span class="va">estimates</span><span class="op">)</span> <span class="co"># should be TRUE!</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co">### For package developers: defining loo methods</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># An example of a possible loo method for 'stanfit' objects (rstan package).</span></span></span>
<span class="r-in"><span><span class="co"># A similar method is included in the rstan package.</span></span></span>
<span class="r-in"><span><span class="co"># In order for users to be able to call loo(stanfit) instead of</span></span></span>
<span class="r-in"><span><span class="co"># loo.stanfit(stanfit) the NAMESPACE needs to be handled appropriately</span></span></span>
<span class="r-in"><span><span class="co"># (roxygen2 and devtools packages are good for that).</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="va">loo.stanfit</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,</span></span>
<span class="r-in"><span>         <span class="va">pars</span> <span class="op">=</span> <span class="st">"log_lik"</span>,</span></span>
<span class="r-in"><span>         <span class="va">...</span>,</span></span>
<span class="r-in"><span>         <span class="va">save_psis</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span></span>
<span class="r-in"><span>         <span class="va">cores</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"mc.cores"</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">LLarray</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="extract_log_lik.html">extract_log_lik</a></span><span class="op">(</span>stanfit <span class="op">=</span> <span class="va">x</span>,</span></span>
<span class="r-in"><span>                                  parameter_name <span class="op">=</span> <span class="va">pars</span>,</span></span>
<span class="r-in"><span>                                  merge_chains <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">r_eff</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="relative_eff.html">relative_eff</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">LLarray</span><span class="op">)</span>, cores <span class="op">=</span> <span class="va">cores</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu">loo</span><span class="fu">::</span><span class="fu">loo.array</span><span class="op">(</span><span class="va">LLarray</span>,</span></span>
<span class="r-in"><span>                 r_eff <span class="op">=</span> <span class="va">r_eff</span>,</span></span>
<span class="r-in"><span>                 cores <span class="op">=</span> <span class="va">cores</span>,</span></span>
<span class="r-in"><span>                 save_psis <span class="op">=</span> <span class="va">save_psis</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Aki Vehtari, Jonah Gabry, Måns Magnusson, Yuling Yao, Paul-Christian Bürkner, Topi Paananen, Andrew Gelman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

