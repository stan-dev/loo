<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- upstream: inst/BS5/templates/head.html; pkgdown-version: 2.1.3, fe04924 --><!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 --><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Diagnostics for Pareto smoothed importance sampling (PSIS) — pareto-k-diagnostic • loo</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_3-0.4.10/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- Font Awesome 7.0.1 for Bluesky icon --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" referrerpolicy="no-referrer"><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Diagnostics for Pareto smoothed importance sampling (PSIS) — pareto-k-diagnostic"><meta name="description" content="Print a diagnostic table summarizing the estimated Pareto shape parameters
and PSIS effective sample sizes, find the indexes of observations for which
the estimated Pareto shape parameter \(k\) is larger than some
threshold value, or plot observation indexes vs. diagnostic estimates.
The Details section below provides a brief overview of the
diagnostics, but we recommend consulting Vehtari, Gelman, and Gabry (2017)
and Vehtari, Simpson, Gelman, Yao, and Gabry (2024) for full details."><meta property="og:description" content="Print a diagnostic table summarizing the estimated Pareto shape parameters
and PSIS effective sample sizes, find the indexes of observations for which
the estimated Pareto shape parameter \(k\) is larger than some
threshold value, or plot observation indexes vs. diagnostic estimates.
The Details section below provides a brief overview of the
diagnostics, but we recommend consulting Vehtari, Gelman, and Gabry (2017)
and Vehtari, Simpson, Gelman, Yao, and Gabry (2024) for full details."><meta property="og:image" content="https://mc-stan.org/loo/logo.svg"><meta name="robots" content="noindex"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <!-- upstream: inst/BS5/templates/navbar.html; pkgdown-version: 2.1.3, fe04924 -->
<!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 -->
<nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">


    <a class="navbar-brand me-2" href="../index.html">
      <!-- Add Stan logo -->
      <picture><source type="image/svg+xml" srcset="../logo.svg"><img src="../logo.png" class="stan-logo" alt="Stan blue hex logo"></source></picture>
      loo
    </a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.8.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Go to homepage"><span class="fa fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-other-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Other Packages</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-other-packages"><li><a class="external-link dropdown-item" href="https://mc-stan.org/bayesplot">bayesplot</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/cmdstanr">cmdstanr</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/posterior">posterior</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/projpred">projpred</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstan">rstan</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstanarm">rstanarm</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstantools">rstantools</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/shinystan">shinystan</a></li>
  </ul></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mc-stan.org/about/">About Stan</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/did:plc:qznndgdnkem2yryu7ipqbpv7" aria-label="Visit our Bluesky profile"><span class="fa fa-brands fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://discourse.mc-stan.org/" aria-label="Visit our forums"><span class="fa fa-users"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stan-dev/loo/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Diagnostics for Pareto smoothed importance sampling (PSIS)</h1>
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/loo/blob/rely-more-on-pkgdown-config/R/diagnostics.R" class="external-link"><code>R/diagnostics.R</code></a></small>
      <div class="d-none name"><code>pareto-k-diagnostic.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Print a diagnostic table summarizing the estimated Pareto shape parameters
and PSIS effective sample sizes, find the indexes of observations for which
the estimated Pareto shape parameter \(k\) is larger than some
<code>threshold</code> value, or plot observation indexes vs. diagnostic estimates.
The <strong>Details</strong> section below provides a brief overview of the
diagnostics, but we recommend consulting Vehtari, Gelman, and Gabry (2017)
and Vehtari, Simpson, Gelman, Yao, and Gabry (2024) for full details.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">pareto_k_table</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">pareto_k_ids</span><span class="op">(</span><span class="va">x</span>, threshold <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">pareto_k_values</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">pareto_k_influence_values</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">psis_n_eff_values</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mcse_loo</span><span class="op">(</span><span class="va">x</span>, threshold <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'psis_loo'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  diagnostic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"k"</span>, <span class="st">"ESS"</span>, <span class="st">"n_eff"</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  label_points <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"PSIS diagnostic plot"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'psis'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  diagnostic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"k"</span>, <span class="st">"ESS"</span>, <span class="st">"n_eff"</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  label_points <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"PSIS diagnostic plot"</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>An object created by <code><a href="loo.html">loo()</a></code> or <code><a href="psis.html">psis()</a></code>.</p></dd>


<dt id="arg-threshold">threshold<a class="anchor" aria-label="anchor" href="#arg-threshold"></a></dt>
<dd><p>For <code>pareto_k_ids()</code>, <code>threshold</code> is the minimum \(k\)
value to flag (default is a sample size <code>S</code> dependend threshold
<code>1 - 1 / log10(S)</code>). For <code>mcse_loo()</code>, if any \(k\) estimates are
greater than <code>threshold</code> the MCSE estimate is returned as <code>NA</code>
See <strong>Details</strong> for the motivation behind these defaults.</p></dd>


<dt id="arg-diagnostic">diagnostic<a class="anchor" aria-label="anchor" href="#arg-diagnostic"></a></dt>
<dd><p>For the <code>plot</code> method, which diagnostic should be
plotted? The options are <code>"k"</code> for Pareto \(k\) estimates (the
default), or <code>"ESS"</code> or <code>"n_eff"</code> for PSIS effective sample size estimates.</p></dd>


<dt id="arg-label-points-">label_points, ...<a class="anchor" aria-label="anchor" href="#arg-label-points-"></a></dt>
<dd><p>For the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method, if <code>label_points</code> is
<code>TRUE</code> the observation numbers corresponding to any values of \(k\)
greater than the diagnostic threshold will be displayed in the plot.
Any arguments specified in <code>...</code> will be passed to <code><a href="https://rdrr.io/r/graphics/text.html" class="external-link">graphics::text()</a></code>
and can be used to control the appearance of the labels.</p></dd>


<dt id="arg-main">main<a class="anchor" aria-label="anchor" href="#arg-main"></a></dt>
<dd><p>For the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method, a title for the plot.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p><code>pareto_k_table()</code> returns an object of class
<code>"pareto_k_table"</code>, which is a matrix with columns <code>"Count"</code>,
<code>"Proportion"</code>, and <code>"Min. n_eff"</code>, and has its own print method.</p>
<p><code>pareto_k_ids()</code> returns an integer vector indicating which
observations have Pareto \(k\) estimates above <code>threshold</code>.</p>
<p><code>pareto_k_values()</code> returns a vector of the estimated Pareto
\(k\) parameters. These represent the reliability of sampling.</p>
<p><code>pareto_k_influence_values()</code> returns a vector of the estimated Pareto
\(k\) parameters. These represent influence of the observations on the
model posterior distribution.</p>
<p><code>psis_n_eff_values()</code> returns a vector of the estimated PSIS
effective sample sizes.</p>
<p><code>mcse_loo()</code> returns the Monte Carlo standard error (MCSE)
estimate for PSIS-LOO. MCSE will be NA if any Pareto \(k\) values are
above <code>threshold</code>.</p>
<p>The <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method is called for its side effect and does not
return anything. If <code>x</code> is the result of a call to <code><a href="loo.html">loo()</a></code>
or <code><a href="psis.html">psis()</a></code> then <code>plot(x, diagnostic)</code> produces a plot of
the estimates of the Pareto shape parameters (<code>diagnostic = "k"</code>) or
estimates of the PSIS effective sample sizes (<code>diagnostic = "ESS"</code>).</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The reliability and approximate convergence rate of the PSIS-based
estimates can be assessed using the estimates for the shape
parameter \(k\) of the generalized Pareto distribution. The
diagnostic threshold for Pareto \(k\) depends on sample size
\(S\) (sample size dependent threshold was introduced by Vehtari
et al. (2024), and before that fixed thresholds of 0.5 and 0.7 were
recommended). For simplicity, <code>loo</code> package uses the nominal sample
size \(S\) when computing the sample size specific
threshold. This provides an optimistic threshold if the effective
sample size is less than 2200, but if MCMC-ESS &gt; S/2 the difference
is usually negligible. Thinning of MCMC draws can be used to
improve the ratio ESS/S.</p><ul><li><p>If \(k &lt; min(1 - 1 / log10(S), 0.7)\), where \(S\) is the
sample size, the PSIS estimate and the corresponding Monte Carlo
standard error estimate are reliable.</p></li>
<li><p>If \(1 - 1 / log10(S) &lt;= k &lt; 0.7\), the PSIS estimate and the
corresponding Monte Carlo standard error estimate are not
reliable, but increasing the (effective) sample size \(S\) above
2200 may help (this will increase the sample size specific
threshold \((1-1/log10(2200)&gt;0.7\) and then the bias specific
threshold 0.7 dominates).</p></li>
<li><p>If \(0.7 &lt;= k &lt; 1\), the PSIS estimate and the corresponding Monte
Carlo standard error have large bias and are not reliable. Increasing
the sample size may reduce the variability in \(k\) estimate, which
may result in lower \(k\) estimate, too.</p></li>
<li><p>If \(k \geq 1\), the target distribution is estimated to
have a non-finite mean. The PSIS estimate and the corresponding Monte
Carlo standard error are not well defined. Increasing the sample size
may reduce the variability in the \(k\) estimate, which
may also result in a lower \(k\) estimate.</p></li>
</ul><div class="section">
<h3 id="what-if-the-estimated-tail-shape-parameter-k-exceeds-the-diagnostic-threshold-">What if the estimated tail shape parameter \(k\)
exceeds the diagnostic threshold?<a class="anchor" aria-label="anchor" href="#what-if-the-estimated-tail-shape-parameter-k-exceeds-the-diagnostic-threshold-"></a></h3>
<p>Importance sampling is likely to
work less well if the marginal posterior \(p(\theta^s | y)\) and
LOO posterior \(p(\theta^s | y_{-i})\) are very different, which
is more likely to happen with a non-robust model and highly
influential observations.  If the estimated tail shape parameter
\(k\) exceeds the diagnostic threshold, the user should be
warned. (Note: If \(k\) is greater than the diagnostic threshold
then WAIC is also likely to fail, but WAIC lacks as accurate
diagnostic.)  When using PSIS in the context of approximate LOO-CV,
we recommend one of the following actions:</p><ul><li><p>With some additional computations, it is possible to transform
the MCMC draws from the posterior distribution to obtain more
reliable importance sampling estimates. This results in a smaller
shape parameter \(k\).  See <code><a href="loo_moment_match.html">loo_moment_match()</a></code> and the
vignette <em>Avoiding model refits in leave-one-out cross-validation
with moment matching</em> for an example of this.</p></li>
<li><p>Sampling from a leave-one-out mixture distribution (see the
vignette <em>Mixture IS leave-one-out cross-validation for
high-dimensional Bayesian models</em>), directly from \(p(\theta^s
  | y_{-i})\) for the problematic observations \(i\), or using
\(K\)-fold cross-validation (see the vignette <em>Holdout
validation and K-fold cross-validation of Stan programs with the
loo package</em>) will generally be more stable.</p></li>
<li><p>Using a model that is more robust to anomalous observations will
generally make approximate LOO-CV more stable.</p></li>
</ul></div>

<div class="section">
<h3 id="observation-influence-statistics">Observation influence statistics<a class="anchor" aria-label="anchor" href="#observation-influence-statistics"></a></h3>
<p>The estimated shape parameter
\(k\) for each observation can be used as a measure of the observation's
influence on posterior distribution of the model. These can be obtained with
<code>pareto_k_influence_values()</code>.</p>
</div>

<div class="section">
<h3 id="effective-sample-size-and-error-estimates">Effective sample size and error estimates<a class="anchor" aria-label="anchor" href="#effective-sample-size-and-error-estimates"></a></h3>
<p>In the case that we
obtain the samples from the proposal distribution via MCMC the <strong>loo</strong>
package also computes estimates for the Monte Carlo error and the effective
sample size for importance sampling, which are more accurate for PSIS than
for IS and TIS (see Vehtari et al (2024) for details). However, the PSIS
effective sample size estimate will be
<strong>over-optimistic when the estimate of \(k\) is greater than</strong>
\(min(1-1/log10(S), 0.7)\), where \(S\) is the sample size.</p>
</div>

    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical Bayesian model
evaluation using leave-one-out cross-validation and WAIC.
<em>Statistics and Computing</em>. 27(5), 1413–1432. doi:10.1007/s11222-016-9696-4
(<a href="https://link.springer.com/article/10.1007/s11222-016-9696-4" class="external-link">journal version</a>,
<a href="https://arxiv.org/abs/1507.04544" class="external-link">preprint arXiv:1507.04544</a>).</p>
<p>Vehtari, A., Simpson, D., Gelman, A., Yao, Y., and Gabry, J. (2024).
Pareto smoothed importance sampling. <em>Journal of Machine Learning Research</em>,
25(72):1-58.
<a href="https://jmlr.org/papers/v25/19-556.html" class="external-link">PDF</a></p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index">
<ul><li><p><code><a href="psis.html">psis()</a></code> for the implementation of the PSIS algorithm.</p></li>
<li><p>The <a href="https://mc-stan.org/loo/articles/online-only/faq.html">FAQ page</a> on
the <strong>loo</strong> website for answers to frequently asked questions.</p></li>
</ul></div>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Aki Vehtari, Jonah Gabry, Måns Magnusson, Yuling Yao, Paul-Christian Bürkner, Topi Paananen, Andrew Gelman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

